<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>{{ page_title|default('Local YouTube Player') }}</title>
  <!-- Favicon using emoji -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>{{ favicon_emoji|default('üéµ') }}</text></svg>">
  <!-- Base player styles -->
  <link rel="stylesheet" href="/static/css/player-base.css">
  <!-- Common player styles -->
  <link rel="stylesheet" href="/static/css/player-common.css">
  <!-- Player specific styles -->
  <link rel="stylesheet" href="/static/css/{{ player_css|default('index-player') }}.css">
  <!-- Icons styles -->
  <link rel="stylesheet" href="/static/css/player-icons.css">
  {% if additional_css %}
  <link rel="stylesheet" href="{{ additional_css }}">
  {% endif %}
  <script>
    // Local server IP injected by Flask for proper Cast functionality
    const SERVER_IP = "{{ server_ip }}";
    // Relative path of playlist (sub-folder) ‚Äì empty for root / all tracks
    const PLAYLIST_REL = "{{ playlist_rel|default('') }}";
    {% if virtual_playlist_config %}
    // Virtual playlist configuration
    const VIRTUAL_PLAYLIST_LIKE_COUNT = {{ virtual_playlist_config.like_count }};
    console.log("üéµ [Virtual] Configure virtual playlist for " + VIRTUAL_PLAYLIST_LIKE_COUNT + " likes");
    {% endif %}
  </script>
</head>
<body>

  
  <div id="controlBar" class="control-bar">
    <div style="display:flex;align-items:center;gap:8px;">
      <!-- Back button -->
      <a href="{{ back_url|default('/') }}" class="modern-btn modern-btn-outline" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;">
        <span class="icon icon-list"></span>
        <span>{{ back_text|default('All Playlists') }}</span>
      </a>
      
      <!-- Navigation buttons -->
      {% if show_prev_next|default(false) %}
      <button id="prevBtn" class="modern-btn modern-btn-secondary" style="display: none;">
        <span class="icon icon-prev"></span>
        <span>Prev</span>
      </button>
      <button id="playBtn" class="modern-btn modern-btn-primary" style="display: none;">
        <span class="icon icon-play"></span>
        <span>Play</span>
      </button>
      <button id="nextBtn" class="modern-btn modern-btn-secondary" style="display: none;">
        <span class="icon icon-next"></span>
        <span>Next</span>
      </button>
      {% endif %}
      
      <!-- Control buttons -->
      <button id="orderBtn" class="modern-btn modern-btn-accent" title="Toggle track order (Shuffle/Smart/Date)">
        <span class="icon icon-order"></span>
        <span>Order: Shuffle</span>
      </button>
      {% if show_stop|default(false) %}
      <button id="stopBtn" class="modern-btn modern-btn-danger" style="display: none;">
        <span class="icon icon-stop"></span>
        <span>Stop</span>
      </button>
      {% endif %}
      <button id="deleteCurrentBtn" class="modern-btn modern-btn-danger">
        <span class="icon icon-delete"></span>
        <span>Delete</span>
      </button>
      {% if show_stream|default(true) %}
      <button id="streamBtn" class="modern-btn modern-btn-success">
        <span class="icon icon-stream"></span>
        <span>Stream</span>
      </button>
      {% endif %}
      <button id="fullBtn" class="modern-btn modern-btn-secondary">
        <span class="icon icon-full"></span>
        <span>Full</span>
      </button>
      <button id="toggleLayoutBtn" class="modern-btn modern-btn-outline" title="Toggle playlist layout (Hidden/Under/Right)">
        <span class="icon icon-layout"></span>
        <span>Playlist: Right</span>
      </button>
    </div>
    
    <!-- Title section -->
    <span style="font-size:20px;color:var(--text);font-weight:500;">
      {% if virtual_playlist_config %}
      ‚ù§Ô∏è <span class="likes-badge">{{ virtual_playlist_config.like_count }}</span> like{{ 's' if virtual_playlist_config.like_count != 1 else '' }}
      {% else %}
      {{ playlist_name|default('Playlist') }}
      {% endif %}
    </span>
  </div>
  
  <div id="playerContainer" class="player-container" style="margin-top:10px; position:relative;">
    <div id="videoWrapper" style="position:relative; flex:1 1 auto;">
      <video id="player" style="width:100%;" playsinline></video>
      
      <!-- custom control bar -->
      <div id="customControls" class="controls">
        <div class="left-group">
          <button id="cPrev" class="ctrl-btn" title="Previous">
            <span class="icon icon-prev"></span>
          </button>
          <button id="cPlay" class="ctrl-btn" title="Play/Pause">
            <span class="icon icon-play"></span>
          </button>
          <button id="cNext" class="ctrl-btn" title="Next">
            <span class="icon icon-next"></span>
          </button>
          <button id="cLike" class="ctrl-btn" title="Like">
            <span class="icon icon-like"></span>
          </button>
          <button id="cDislike" class="ctrl-btn" title="Dislike">
            <span class="icon icon-dislike"></span>
          </button>
          <button id="cYoutube" class="ctrl-btn" title="Open on YouTube">
            <span class="icon icon-youtube"></span>
          </button>
          {% if show_cast|default(true) %}
          <button id="castBtn" class="ctrl-btn" title="Play on TV">
            <span class="icon icon-cast"></span>
          </button>
          {% endif %}
          <button id="cMute" class="ctrl-btn" title="Mute/Unmute">
            <span class="icon icon-volume"></span>
          </button>
          <input type="range" id="cVol" min="0" max="1" step="0.01" value="1" class="vol-slider" />
          <button id="cSpeed" class="ctrl-btn" title="Playback Speed: 1x">
            <span class="icon icon-clock"></span>
            <span id="speedLabel">1x</span>
          </button>
        </div>
        <div id="progressContainer" class="progress"><div id="progressBar" class="progress-bar"></div></div>
        <span id="timeLabel" class="time">0:00 / 0:00</span>
        <button id="cFull" class="ctrl-btn" title="Fullscreen">
          <span class="icon icon-full"></span>
        </button>
      </div>
    </div>
    
    <!-- Current track title display -->
    <div id="currentTrackTitle">
      <span id="currentTrackName">No track selected</span>
    </div>
    
    <div id="playlistPanel" class="playlist-panel">
      <ul id="tracklist" class="side-list"></ul>
    </div>
  </div>

  <!-- Initialize track title manager -->
  <script type="module">
    import { initializeTrackTitleManager } from '/static/js/modules/track-title-manager.js';
    initializeTrackTitleManager();
  </script>
  
  <!-- Load player script -->
  <script type="module" src="/static/{{ player_js|default('player') }}.js"></script>
  
  {% if show_cast|default(true) %}
  <!-- Google Cast integration -->
  <script>
    // Load Google Cast API with detailed debugging
    console.log('üîÑ CAST DEBUG: Starting Google Cast API script loading...');
    
    const castScript = document.createElement('script');
    castScript.src = 'https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1';
    
    castScript.onerror = function(error) {
      console.error('‚ùå CAST DEBUG: Failed to load Google Cast API script!');
      console.error('‚ùå CAST DEBUG: Script error details:', error);
      console.log('üîÑ CAST DEBUG: Attempting fallback behavior...');
      
      // Fallback: try to show cast button anyway
      const castBtn = document.getElementById('castBtn');
      if(castBtn) {
        castBtn.style.display = 'inline-flex';
        castBtn.style.opacity = '0.5';
        castBtn.title = 'Cast API not available';
        console.log('‚úÖ CAST DEBUG: Cast button shown with API unavailable indicator');
      } else {
        console.error('‚ùå CAST DEBUG: Cast button not found during fallback');
      }
    };
    
    castScript.onload = function() {
      console.log('‚úÖ CAST DEBUG: Google Cast API script loaded successfully!');
      console.log('üîÑ CAST DEBUG: Waiting for Cast framework to initialize...');
      
      // Check if Cast API objects are available
      setTimeout(() => {
        console.log('üîç CAST DEBUG: Checking Cast API availability...');
        console.log('üîç CAST DEBUG: window.cast available:', typeof window.cast !== 'undefined');
        console.log('üîç CAST DEBUG: chrome.cast available:', typeof chrome !== 'undefined' && typeof chrome.cast !== 'undefined');
        
        if(typeof window.__onGCastApiAvailable === 'function') {
          console.log('‚úÖ CAST DEBUG: Cast API callback function is ready');
        } else {
          console.warn('‚ùå CAST DEBUG: Cast API callback function not found!');
        }
      }, 100);
    };
    
    console.log('üîÑ CAST DEBUG: Appending Cast API script to document head...');
    document.head.appendChild(castScript);
    console.log('‚úÖ CAST DEBUG: Cast API script element added to DOM');
  </script>
  {% endif %}
</body>
</html> 