<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncPlay-Hub - Channels</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“º</text></svg>">
    
    <!-- Include Sidebar Styles -->
    {% include 'sidebar_styles.html' %}
    
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --accent-primary: #4a9eff;
            --accent-secondary: #ff6b35;
            --border-color: #444444;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .channel-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .group-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .group-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .btn-primary:hover {
            background: #3a8de8;
            border-color: #3a8de8;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #45a049;
            border-color: #45a049;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .btn-youtube {
            background: #ff0000;
            border-color: #ff0000;
            color: white;
        }

        .btn-youtube:hover {
            background: #cc0000;
            border-color: #cc0000;
            color: white;
        }

        .btn-muted {
            background: var(--text-muted);
            border-color: var(--text-muted);
            color: white;
        }

        .btn-muted:hover {
            background: #777;
            border-color: #777;
            color: white;
        }

        .channels-list {
            display: grid;
            gap: 12px;
        }

        .channel-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .channel-stats {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .channel-actions {
            display: flex;
            gap: 8px;
        }

        .auto-delete-badge {
            background: var(--warning);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .likes-included-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .likes-excluded-badge {
            background: var(--text-muted);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .create-group-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin: 10% auto;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .nav-links {
                flex-wrap: wrap;
            }

            .group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .channel-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .channel-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    
    <div class="layout">
        <!-- Include Sidebar -->
        {% include 'sidebar.html' %}

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <header>
                    <h1>
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="20" height="15" x="2" y="7" rx="2" ry="2"/>
                            <polyline points="17,2 12,7 7,2"/>
                        </svg>
                        Channels
                    </h1>
                </header>

                <main>
            <!-- Create New Group Section -->
            <div class="create-group-section">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="20" height="15" x="2" y="3" rx="2" ry="2"></rect>
                        <circle cx="8" cy="21" r="1"></circle>
                        <circle cx="16" cy="21" r="1"></circle>
                    </svg>
                </div>
                <h3>Organize Your Content with Channel Groups</h3>
                <p style="margin: 12px 0; color: var(--text-secondary);">
                    Group YouTube channels by type: Music for endless listening, News for auto-cleanup, Education for sequential learning.
                </p>
                <button class="btn btn-primary" onclick="showCreateGroupModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14m-7-7v14"/>
                    </svg>
                    Create Channel Group
                </button>
            </div>

            <!-- Channel Groups -->
            <div id="channelGroups">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"></path>
                    </svg>
                </div>
                <h3>No Channel Groups Yet</h3>
                <p>Create your first channel group to start organizing YouTube content.</p>
            </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Channel Group</h3>
                <span class="close" onclick="hideCreateGroupModal()">&times;</span>
            </div>
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label" for="groupName">Group Name</label>
                    <input type="text" id="groupName" class="form-input" placeholder="e.g., Music, News, Education" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="behaviorType">Behavior Type</label>
                    <select id="behaviorType" class="form-select" required>
                        <option value="music">Music - Random play, no auto-delete</option>
                        <option value="news">News - Newest first, auto-delete after finish</option>
                        <option value="education">Education - Oldest first, optional auto-delete</option>
                        <option value="podcasts">Podcasts - Oldest first, no auto-delete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="playOrder">Play Order</label>
                    <select id="playOrder" class="form-select" required>
                        <option value="random">Random</option>
                        <option value="newest_first">Newest First</option>
                        <option value="oldest_first">Oldest First</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoDelete" class="form-checkbox">
                        <label class="form-label" for="autoDelete">Auto-delete tracks after finish (>5 seconds, not liked)</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeInLikes" class="form-checkbox" checked>
                        <label class="form-label" for="includeInLikes">Include tracks from this group in likes playlists</label>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn" onclick="hideCreateGroupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14m-7-7v14"/>
                        </svg>
                        Create Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Channel Modal -->
    <div id="addChannelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add YouTube Channel</h3>
                <span class="close" onclick="hideAddChannelModal()">&times;</span>
            </div>
            <form id="addChannelForm">
                <div class="form-group">
                    <label class="form-label" for="channelUrl">Channel URL</label>
                    <input type="url" id="channelUrl" class="form-input" 
                           placeholder="https://www.youtube.com/@ChannelName/videos" required>
                    <small style="color: var(--text-muted);">
                        Supported formats: @ChannelName/videos, @ChannelName, /c/ChannelName/videos
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dateFrom">Download videos from</label>
                    <select id="dateFromPreset" class="form-select">
                        <option value="">No time limit</option>
                        <option value="1day">Last 24 hours</option>
                        <option value="1week">Last week</option>
                        <option value="1month">Last month</option>
                        <option value="custom">Custom date...</option>
                    </select>
                </div>
                <div class="form-group" id="customDateGroup" style="display: none;">
                    <label class="form-label" for="customDate">Custom start date</label>
                    <input type="date" id="customDate" class="form-input">
                </div>
                <input type="hidden" id="selectedGroupId" value="">
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn" onclick="hideAddChannelModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14m-7-7v14"/>
                        </svg>
                        Add Channel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let channelGroups = [];

        // Load channel groups from API - removed duplicate function

        // Modal functions
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        function hideCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.getElementById('createGroupForm').reset();
        }

        function showAddChannelModal(groupId) {
            document.getElementById('selectedGroupId').value = groupId;
            document.getElementById('addChannelModal').style.display = 'block';
        }

        function hideAddChannelModal() {
            document.getElementById('addChannelModal').style.display = 'none';
            document.getElementById('addChannelForm').reset();
            document.getElementById('customDateGroup').style.display = 'none';
        }

        // Date preset handling
        document.getElementById('dateFromPreset').addEventListener('change', function() {
            const customGroup = document.getElementById('customDateGroup');
            if (this.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        });

        // Behavior type auto-updates
        document.getElementById('behaviorType').addEventListener('change', function() {
            const playOrder = document.getElementById('playOrder');
            const autoDelete = document.getElementById('autoDelete');
            
            switch(this.value) {
                case 'music':
                    playOrder.value = 'random';
                    autoDelete.checked = false;
                    break;
                case 'news':
                    playOrder.value = 'newest_first';
                    autoDelete.checked = true;
                    break;
                case 'education':
                case 'podcasts':
                    playOrder.value = 'oldest_first';
                    autoDelete.checked = false;
                    break;
            }
        });

        // Form submissions
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createChannelGroup();
        });

        document.getElementById('addChannelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addChannel();
        });

        // API functions
        async function loadChannelGroups() {
            try {
                const response = await fetch('/api/channels/channel_groups');
                const result = await response.json();
                
                if (result.status === 'ok') {
                    channelGroups = result.groups;
                    
                    // Load channels for each group
                    for (let group of channelGroups) {
                        await loadChannelsForGroup(group.id);
                    }
                    
                    renderChannelGroups();
                } else {
                    console.error('Error loading channel groups:', result.message);
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load channel groups:', error);
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        async function loadChannelsForGroup(groupId) {
            try {
                const response = await fetch(`/api/channels/groups/${groupId}`);
                const result = await response.json();
                
                if (result.status === 'ok') {
                    // Find the group and add channels to it
                    const group = channelGroups.find(g => g.id === groupId);
                    if (group) {
                        group.channels = result.channels;
                    }
                }
            } catch (error) {
                console.error(`Failed to load channels for group ${groupId}:`, error);
            }
        }

        async function createChannelGroup() {
            const formData = {
                name: document.getElementById('groupName').value,
                behavior_type: document.getElementById('behaviorType').value,
                play_order: document.getElementById('playOrder').value,
                auto_delete_enabled: document.getElementById('autoDelete').checked,
                include_in_likes: document.getElementById('includeInLikes').checked
            };

            try {
                const response = await fetch('/api/channels/create_channel_group', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.status === 'ok') {
                    hideCreateGroupModal();
                    loadChannelGroups(); // Reload the page
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function addChannel() {
            const datePreset = document.getElementById('dateFromPreset').value;
            let dateFrom = null;

            if (datePreset && datePreset !== 'custom') {
                const now = new Date();
                switch(datePreset) {
                    case '1day':
                        now.setDate(now.getDate() - 1);
                        break;
                    case '1week':
                        now.setDate(now.getDate() - 7);
                        break;
                    case '1month':
                        now.setMonth(now.getMonth() - 1);
                        break;
                }
                dateFrom = now.toISOString().split('T')[0];
            } else if (datePreset === 'custom') {
                dateFrom = document.getElementById('customDate').value;
            }

            const formData = {
                url: document.getElementById('channelUrl').value,
                group_id: parseInt(document.getElementById('selectedGroupId').value),
                date_from: dateFrom
            };

            try {
                const response = await fetch('/api/channels/add_channel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.status === 'started') {
                    hideAddChannelModal();
                    alert('âœ… Channel download started. It will appear once finished.');
                    
                    // Reload channels for the specific group
                    const groupId = parseInt(document.getElementById('selectedGroupId').value);
                    await loadChannelsForGroup(groupId);
                    renderChannelGroups();
                } else {
                    alert('Error: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function syncChannelGroup(groupId) {
            try {
                const response = await fetch(`/api/channels/sync_channel_group/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                if (result.status === 'started') {
                    alert('âœ… Group sync started in background');
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function toggleIncludeInLikes(groupId, currentState) {
            try {
                const newState = !currentState;
                const response = await fetch(`/api/channels/update_channel_group/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        include_in_likes: newState
                    })
                });

                const result = await response.json();
                if (result.status === 'ok') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    const action = newState ? 'enabled' : 'disabled';
                    alert(`âœ… Likes playlist inclusion ${action} for this group`);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function syncChannel(channelId) {
            try {
                const response = await fetch(`/api/channels/sync_channel/${channelId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                if (result.status === 'started') {
                    alert('âœ… Channel sync started in background');
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function refreshChannelStats(channelId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = 'â³ Refreshing...';
                button.disabled = true;
                
                // First scan the database to update tracks table
                const scanResponse = await fetch('/api/scan', {
                    method: 'POST'
                });
                
                const scanResult = await scanResponse.json();
                if (scanResult.status !== 'ok') {
                    throw new Error(`Database scan failed: ${scanResult.message || 'Unknown error'}`);
                }
                
                // Then refresh the specific channel stats
                const refreshResponse = await fetch(`/api/channels/refresh_channel_stats/${channelId}`, {
                    method: 'POST'
                });
                
                const result = await refreshResponse.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`âœ… Channel statistics refreshed: ${result.track_count} tracks found`);
                } else {
                    alert('Error refreshing channel stats: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to refresh stats: ' + error.message);
            } finally {
                // Restore button state
                try {
                    const button = event.target;
                    button.innerHTML = originalText;
                    button.disabled = false;
                } catch (e) {
                    // Button might not be available if page was refreshed
                }
            }
        }

        // Rendering functions
        function renderChannelGroups() {
            const container = document.getElementById('channelGroups');
            const emptyState = document.getElementById('emptyState');

            if (channelGroups.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = channelGroups.map(group => renderChannelGroup(group)).join('');
        }

        function renderChannelGroup(group) {
            const icon = getGroupIcon(group.behavior_type);
            const autoDeleteBadge = group.auto_delete_enabled ? 
                '<span class="auto-delete-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path></svg> Auto-delete ON</span>' : '';
            const likesIncludedBadge = group.include_in_likes ? 
                '<span class="likes-included-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> Likes playlists</span>' : 
                '<span class="likes-excluded-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg> Not in likes</span>';

            return `
                <div class="channel-group">
                    <div class="group-header">
                        <div>
                            <div class="group-title">
                                ${icon} ${group.name}
                                ${autoDeleteBadge}
                                ${likesIncludedBadge}
                            </div>
                            <div class="group-stats">
                                ${group.channel_count} channels, ${group.total_tracks} tracks
                                â€¢ ${formatPlayOrder(group.play_order)} order
                            </div>
                        </div>
                        <div class="group-actions">
                            <button class="btn" onclick="showAddChannelModal(${group.id})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M5 12h14m-7-7v14"/>
                                </svg>
                                Add Channel
                            </button>
                            <button class="btn ${group.include_in_likes ? 'btn-success' : 'btn-muted'}" onclick="toggleIncludeInLikes(${group.id}, ${group.include_in_likes})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                ${group.include_in_likes ? 'Disable' : 'Enable'} Likes
                            </button>
                            ${group.channel_count > 0 ? `
                                <button class="btn btn-success" onclick="syncChannelGroup(${group.id})">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 15.64-8.13M22 12.5a10 10 0 0 1-15.64 8.13"/>
                                    </svg>
                                    Sync All
                                </button>
                            ` : `
                                <button class="btn btn-danger" onclick="deleteEmptyChannelGroup(${group.id}, '${group.name}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                                    </svg>
                                    Delete Empty Group
                                </button>
                            `}
                        </div>
                    </div>
                    <div class="channels-list" id="channels-${group.id}">
                        ${renderChannelsForGroup(group.id)}
                    </div>
                </div>
            `;
        }

        function renderChannelsForGroup(groupId) {
            const group = channelGroups.find(g => g.id === groupId);
            if (!group || !group.channels || group.channels.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No channels yet. Click "Add Channel" to get started.</div>';
            }

            return group.channels.map(channel => `
                <div class="channel-item">
                    <div class="channel-info">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4"/>
                            <path d="M16 8v5a3 3 0 0 0 6 0v-5a4 4 0 1 0-8 8"/>
                            <path d="M2 8v5a3 3 0 0 0 6 0v-5a4 4 0 1 0-8 8"/>
                        </svg>
                        <div>
                            <div class="channel-name">${channel.name}</div>
                            <div class="channel-stats">
                                ${channel.track_count || 0} tracks
                                ${channel.last_sync_ts ? 'â€¢ Last sync: ' + new Date(channel.last_sync_ts).toLocaleString('ru-RU', { 
                                    year: 'numeric', 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit', 
                                    second: '2-digit',
                                    hour12: false 
                                }) : 'â€¢ Never synced'}
                            </div>
                        </div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-youtube" onclick="openYouTubeChannel('${channel.url}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/>
                                <path d="m10,15 5-3-5-3z"/>
                            </svg>
                            YouTube
                        </button>
                        <button class="btn" onclick="syncChannel(${channel.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 15.64-8.13M22 12.5a10 10 0 0 1-15.64 8.13"/>
                            </svg>
                            Sync
                        </button>
                        <button class="btn btn-accent" onclick="refreshChannelStats(${channel.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M8 16H3v5"/>
                            </svg>
                            Refresh
                        </button>
                        <button class="btn btn-danger" onclick="removeChannel(${channel.id}, '${channel.name}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                            </svg>
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function formatPlayOrder(playOrder) {
            switch (playOrder) {
                case 'random':
                    return 'random';
                case 'newest_first':
                    return 'newest first';
                case 'oldest_first':
                    return 'oldest first';
                default:
                    return playOrder ? playOrder.replace('_', ' ') : 'random';
            }
        }

        function getGroupIcon(behaviorType) {
            switch (behaviorType) {
                case 'music': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
                case 'news': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>';
                case 'education': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>';
                case 'podcasts': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>';
                default: 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="15" x="2" y="3" rx="2" ry="2"></rect><circle cx="8" cy="21" r="1"></circle><circle cx="16" cy="21" r="1"></circle></svg>';
            }
        }

        async function removeChannel(channelId, channelName) {
            // Confirm deletion with user
            const confirmed = confirm(
                `Are you sure you want to remove channel "${channelName}" from the group?\n\n` +
                `Options:\n` +
                `- Click OK to remove channel from group, BUT KEEP files on disk\n` +
                `- Click Cancel to abort\n\n` +
                `Note: You can later add this channel to another group.`
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/channels/remove_channel/${channelId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        keep_files: true  // Always keep files for moving between groups
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`âœ… Channel "${channelName}" removed from group.\n\nFiles saved on disk - you can now add this channel to another group.`);
                } else {
                    alert('Error removing channel: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        function openYouTubeChannel(channelUrl) {
            // Open YouTube channel in new tab using the original URL
            if (channelUrl) {
                window.open(channelUrl, '_blank');
            } else {
                alert('Channel URL not available');
            }
        }

        function editChannel(channelId) {
            // TODO: Implement channel editing
            alert('Channel editing will be implemented in the next update!');
        }

        async function deleteEmptyChannelGroup(groupId, groupName) {
            // Confirm deletion with user
            const confirmed = confirm(
                `Are you sure you want to delete the empty channel group "${groupName}"?\n\n` +
                `This group contains no channels, so it can be safely deleted.\n\n` +
                `This action cannot be undone.`
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/channels/delete_channel_group/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`âœ… Empty channel group "${groupName}" successfully deleted.`);
                } else {
                    alert('Error deleting group: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadChannelGroups();
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createGroupModal');
            const addModal = document.getElementById('addChannelModal');
            
            if (event.target === createModal) {
                hideCreateGroupModal();
            }
            if (event.target === addModal) {
                hideAddChannelModal();
            }
        });

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target) && 
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });
    </script>
</body>
</html> 