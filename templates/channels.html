<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncPlay-Hub - Channels</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>📺</text></svg>">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --accent-primary: #4a9eff;
            --accent-secondary: #ff6b35;
            --border-color: #444444;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .channel-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .group-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .group-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .btn-primary:hover {
            background: #3a8de8;
            border-color: #3a8de8;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #45a049;
            border-color: #45a049;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .channels-list {
            display: grid;
            gap: 12px;
        }

        .channel-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .channel-stats {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .channel-actions {
            display: flex;
            gap: 8px;
        }

        .auto-delete-badge {
            background: var(--warning);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .create-group-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin: 10% auto;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .nav-links {
                flex-wrap: wrap;
            }

            .group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .channel-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .channel-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="20" height="15" x="2" y="7" rx="2" ry="2"/>
                    <polyline points="17,2 12,7 7,2"/>
                </svg>
                Channels
            </h1>
            <nav class="nav-links">
                <a href="/" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    Home
                </a>
                <a href="/playlists" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z"/>
                    </svg>
                    Playlists
                </a>
                <a href="/deleted" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                    </svg>
                    Deleted
                </a>
                <a href="/events" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3v18l18-9-18-9Z"/>
                    </svg>
                    Events
                </a>
                <a href="/remote" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="3" rx="2"/>
                        <path d="M9 9h6v6H9V9Z"/>
                    </svg>
                    Remote
                </a>
            </nav>
        </header>

        <main>
            <!-- Create New Group Section -->
            <div class="create-group-section">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="20" height="15" x="2" y="3" rx="2" ry="2"></rect>
                        <circle cx="8" cy="21" r="1"></circle>
                        <circle cx="16" cy="21" r="1"></circle>
                    </svg>
                </div>
                <h3>Organize Your Content with Channel Groups</h3>
                <p style="margin: 12px 0; color: var(--text-secondary);">
                    Group YouTube channels by type: Music for endless listening, News for auto-cleanup, Education for sequential learning.
                </p>
                <button class="btn btn-primary" onclick="showCreateGroupModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14m-7-7v14"/>
                    </svg>
                    Create Channel Group
                </button>
            </div>

            <!-- Channel Groups -->
            <div id="channelGroups">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"></path>
                    </svg>
                </div>
                <h3>No Channel Groups Yet</h3>
                <p>Create your first channel group to start organizing YouTube content.</p>
            </div>
        </main>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Channel Group</h3>
                <span class="close" onclick="hideCreateGroupModal()">&times;</span>
            </div>
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label" for="groupName">Group Name</label>
                    <input type="text" id="groupName" class="form-input" placeholder="e.g., Music, News, Education" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="behaviorType">Behavior Type</label>
                    <select id="behaviorType" class="form-select" required>
                        <option value="music">Music - Random play, no auto-delete</option>
                        <option value="news">News - Chronological play, auto-delete after finish</option>
                        <option value="education">Education - Sequential play, optional auto-delete</option>
                        <option value="podcasts">Podcasts - Sequential play, no auto-delete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="playOrder">Play Order</label>
                    <select id="playOrder" class="form-select" required>
                        <option value="random">Random</option>
                        <option value="chronological_newest">Newest First</option>
                        <option value="chronological_oldest">Oldest First</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoDelete" class="form-checkbox">
                        <label class="form-label" for="autoDelete">Auto-delete tracks after finish (>5 seconds, not liked)</label>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn" onclick="hideCreateGroupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14m-7-7v14"/>
                        </svg>
                        Create Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Channel Modal -->
    <div id="addChannelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add YouTube Channel</h3>
                <span class="close" onclick="hideAddChannelModal()">&times;</span>
            </div>
            <form id="addChannelForm">
                <div class="form-group">
                    <label class="form-label" for="channelUrl">Channel URL</label>
                    <input type="url" id="channelUrl" class="form-input" 
                           placeholder="https://www.youtube.com/@ChannelName/videos" required>
                    <small style="color: var(--text-muted);">
                        Supported formats: @ChannelName/videos, @ChannelName, /c/ChannelName/videos
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dateFrom">Download videos from</label>
                    <select id="dateFromPreset" class="form-select">
                        <option value="">No time limit</option>
                        <option value="1day">Last 24 hours</option>
                        <option value="1week">Last week</option>
                        <option value="1month">Last month</option>
                        <option value="custom">Custom date...</option>
                    </select>
                </div>
                <div class="form-group" id="customDateGroup" style="display: none;">
                    <label class="form-label" for="customDate">Custom start date</label>
                    <input type="date" id="customDate" class="form-input">
                </div>
                <input type="hidden" id="selectedGroupId" value="">
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn" onclick="hideAddChannelModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14m-7-7v14"/>
                        </svg>
                        Add Channel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let channelGroups = [];

        // Load channel groups from API - removed duplicate function

        // Modal functions
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        function hideCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.getElementById('createGroupForm').reset();
        }

        function showAddChannelModal(groupId) {
            document.getElementById('selectedGroupId').value = groupId;
            document.getElementById('addChannelModal').style.display = 'block';
        }

        function hideAddChannelModal() {
            document.getElementById('addChannelModal').style.display = 'none';
            document.getElementById('addChannelForm').reset();
            document.getElementById('customDateGroup').style.display = 'none';
        }

        // Date preset handling
        document.getElementById('dateFromPreset').addEventListener('change', function() {
            const customGroup = document.getElementById('customDateGroup');
            if (this.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        });

        // Behavior type auto-updates
        document.getElementById('behaviorType').addEventListener('change', function() {
            const playOrder = document.getElementById('playOrder');
            const autoDelete = document.getElementById('autoDelete');
            
            switch(this.value) {
                case 'music':
                    playOrder.value = 'random';
                    autoDelete.checked = false;
                    break;
                case 'news':
                    playOrder.value = 'chronological_newest';
                    autoDelete.checked = true;
                    break;
                case 'education':
                case 'podcasts':
                    playOrder.value = 'chronological_oldest';
                    autoDelete.checked = false;
                    break;
            }
        });

        // Form submissions
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createChannelGroup();
        });

        document.getElementById('addChannelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addChannel();
        });

        // API functions
        async function loadChannelGroups() {
            try {
                const response = await fetch('/api/channel_groups');
                const result = await response.json();
                
                if (result.status === 'ok') {
                    channelGroups = result.groups;
                    
                    // Load channels for each group
                    for (let group of channelGroups) {
                        await loadChannelsForGroup(group.id);
                    }
                    
                    renderChannelGroups();
                } else {
                    console.error('Error loading channel groups:', result.message);
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load channel groups:', error);
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        async function loadChannelsForGroup(groupId) {
            try {
                const response = await fetch(`/api/channels/${groupId}`);
                const result = await response.json();
                
                if (result.status === 'ok') {
                    // Find the group and add channels to it
                    const group = channelGroups.find(g => g.id === groupId);
                    if (group) {
                        group.channels = result.channels;
                    }
                }
            } catch (error) {
                console.error(`Failed to load channels for group ${groupId}:`, error);
            }
        }

        async function createChannelGroup() {
            const formData = {
                name: document.getElementById('groupName').value,
                behavior_type: document.getElementById('behaviorType').value,
                play_order: document.getElementById('playOrder').value,
                auto_delete_enabled: document.getElementById('autoDelete').checked
            };

            try {
                const response = await fetch('/api/create_channel_group', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.status === 'ok') {
                    hideCreateGroupModal();
                    loadChannelGroups(); // Reload the page
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function addChannel() {
            const datePreset = document.getElementById('dateFromPreset').value;
            let dateFrom = null;

            if (datePreset && datePreset !== 'custom') {
                const now = new Date();
                switch(datePreset) {
                    case '1day':
                        now.setDate(now.getDate() - 1);
                        break;
                    case '1week':
                        now.setDate(now.getDate() - 7);
                        break;
                    case '1month':
                        now.setMonth(now.getMonth() - 1);
                        break;
                }
                dateFrom = now.toISOString().split('T')[0];
            } else if (datePreset === 'custom') {
                dateFrom = document.getElementById('customDate').value;
            }

            const formData = {
                url: document.getElementById('channelUrl').value,
                group_id: parseInt(document.getElementById('selectedGroupId').value),
                date_from: dateFrom
            };

            try {
                const response = await fetch('/api/add_channel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.status === 'started') {
                    hideAddChannelModal();
                    alert('✅ Channel download started. It will appear once finished.');
                    
                    // Reload channels for the specific group
                    const groupId = parseInt(document.getElementById('selectedGroupId').value);
                    await loadChannelsForGroup(groupId);
                    renderChannelGroups();
                } else {
                    alert('Error: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function syncChannelGroup(groupId) {
            try {
                const response = await fetch(`/api/sync_channel_group/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                if (result.status === 'started') {
                    alert('✅ Group sync started in background');
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function syncChannel(channelId) {
            try {
                const response = await fetch(`/api/sync_channel/${channelId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                if (result.status === 'started') {
                    alert('✅ Channel sync started in background');
                } else {
                    alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error);
            }
        }

        async function refreshChannelStats(channelId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '⏳ Refreshing...';
                button.disabled = true;
                
                // First scan the database to update tracks table
                const scanResponse = await fetch('/api/scan', {
                    method: 'POST'
                });
                
                const scanResult = await scanResponse.json();
                if (scanResult.status !== 'ok') {
                    throw new Error(`Database scan failed: ${scanResult.message || 'Unknown error'}`);
                }
                
                // Then refresh the specific channel stats
                const refreshResponse = await fetch(`/api/refresh_channel_stats/${channelId}`, {
                    method: 'POST'
                });
                
                const result = await refreshResponse.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`✅ Channel statistics refreshed: ${result.track_count} tracks found`);
                } else {
                    alert('Error refreshing channel stats: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to refresh stats: ' + error.message);
            } finally {
                // Restore button state
                try {
                    const button = event.target;
                    button.innerHTML = originalText;
                    button.disabled = false;
                } catch (e) {
                    // Button might not be available if page was refreshed
                }
            }
        }

        // Rendering functions
        function renderChannelGroups() {
            const container = document.getElementById('channelGroups');
            const emptyState = document.getElementById('emptyState');

            if (channelGroups.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = channelGroups.map(group => renderChannelGroup(group)).join('');
        }

        function renderChannelGroup(group) {
            const icon = getGroupIcon(group.behavior_type);
            const autoDeleteBadge = group.auto_delete_enabled ? 
                '<span class="auto-delete-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path></svg> Auto-delete ON</span>' : '';

            return `
                <div class="channel-group">
                    <div class="group-header">
                        <div>
                            <div class="group-title">
                                ${icon} ${group.name}
                                ${autoDeleteBadge}
                            </div>
                            <div class="group-stats">
                                ${group.channel_count} channels, ${group.total_tracks} tracks
                                • ${group.play_order.replace('_', ' ')} order
                            </div>
                        </div>
                        <div class="group-actions">
                            <button class="btn" onclick="showAddChannelModal(${group.id})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M5 12h14m-7-7v14"/>
                                </svg>
                                Add Channel
                            </button>
                            ${group.channel_count > 0 ? `
                                <button class="btn btn-success" onclick="syncChannelGroup(${group.id})">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 15.64-8.13M22 12.5a10 10 0 0 1-15.64 8.13"/>
                                    </svg>
                                    Sync All
                                </button>
                            ` : `
                                <button class="btn btn-danger" onclick="deleteEmptyChannelGroup(${group.id}, '${group.name}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                                    </svg>
                                    Delete Empty Group
                                </button>
                            `}
                        </div>
                    </div>
                    <div class="channels-list" id="channels-${group.id}">
                        ${renderChannelsForGroup(group.id)}
                    </div>
                </div>
            `;
        }

        function renderChannelsForGroup(groupId) {
            const group = channelGroups.find(g => g.id === groupId);
            if (!group || !group.channels || group.channels.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No channels yet. Click "Add Channel" to get started.</div>';
            }

            return group.channels.map(channel => `
                <div class="channel-item">
                    <div class="channel-info">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4"/>
                            <path d="M16 8v5a3 3 0 0 0 6 0v-5a4 4 0 1 0-8 8"/>
                            <path d="M2 8v5a3 3 0 0 0 6 0v-5a4 4 0 1 0-8 8"/>
                        </svg>
                        <div>
                            <div class="channel-name">${channel.name}</div>
                            <div class="channel-stats">
                                ${channel.track_count || 0} tracks
                                ${channel.last_sync_ts ? '• Last sync: ' + new Date(channel.last_sync_ts).toLocaleDateString() : '• Never synced'}
                            </div>
                        </div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn" onclick="syncChannel(${channel.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 15.64-8.13M22 12.5a10 10 0 0 1-15.64 8.13"/>
                            </svg>
                            Sync
                        </button>
                        <button class="btn btn-accent" onclick="refreshChannelStats(${channel.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M8 16H3v5"/>
                            </svg>
                            Refresh
                        </button>
                        <button class="btn btn-danger" onclick="removeChannel(${channel.id}, '${channel.name}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                            </svg>
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getGroupIcon(behaviorType) {
            switch (behaviorType) {
                case 'music': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
                case 'news': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>';
                case 'education': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>';
                case 'podcasts': 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>';
                default: 
                    return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="15" x="2" y="3" rx="2" ry="2"></rect><circle cx="8" cy="21" r="1"></circle><circle cx="16" cy="21" r="1"></circle></svg>';
            }
        }

        async function removeChannel(channelId, channelName) {
            // Confirm deletion with user
            const confirmed = confirm(
                `Are you sure you want to remove channel "${channelName}" from the group?\n\n` +
                `Options:\n` +
                `- Click OK to remove channel from group, BUT KEEP files on disk\n` +
                `- Click Cancel to abort\n\n` +
                `Note: You can later add this channel to another group.`
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/remove_channel/${channelId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        keep_files: true  // Always keep files for moving between groups
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`✅ Channel "${channelName}" removed from group.\n\nFiles saved on disk - you can now add this channel to another group.`);
                } else {
                    alert('Error removing channel: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        function editChannel(channelId) {
            // TODO: Implement channel editing
            alert('Channel editing will be implemented in the next update!');
        }

        async function deleteEmptyChannelGroup(groupId, groupName) {
            // Confirm deletion with user
            const confirmed = confirm(
                `Are you sure you want to delete the empty channel group "${groupName}"?\n\n` +
                `This group contains no channels, so it can be safely deleted.\n\n` +
                `This action cannot be undone.`
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/delete_channel_group/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Reload and refresh the display
                    await loadChannelGroups();
                    renderChannelGroups();
                    
                    alert(`✅ Empty channel group "${groupName}" successfully deleted.`);
                } else {
                    alert('Error deleting group: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Request failed: ' + error.message);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadChannelGroups();
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createGroupModal');
            const addModal = document.getElementById('addChannelModal');
            
            if (event.target === createModal) {
                hideCreateGroupModal();
            }
            if (event.target === addModal) {
                hideAddChannelModal();
            }
        });
    </script>
</body>
</html> 