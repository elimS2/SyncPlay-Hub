<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track â€“ {{ (metadata.title if metadata and metadata['title']) or track.get('name') or video_id }}</title>
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽµ</text></svg>">
  {% include 'sidebar_styles.html' %}
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/track.css">
</head>
<body>
  <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
  <div class="layout">
    {% include 'sidebar.html' %}
    <div class="main-content">

      <!-- Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">
            {{ (metadata.title if metadata and metadata['title']) or track.get('name') or 'Track' }}
          </h1>
          <div class="muted mono">Video ID: {{ video_id }}</div>
          {% if track.is_deleted %}
            <span class="badge badge-deleted">Deleted{% if track.deletion_date %} ({{ track.deletion_date }}){% endif %}</span>
          {% else %}
            <span class="badge badge-active">Active</span>
          {% endif %}
        </div>
        <div class="actions">
          <a class="btn btn-secondary" href="https://youtu.be/{{ video_id }}" target="_blank" rel="noopener" aria-label="Open on YouTube (opens in new tab)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 15l5.19-3L10 9v6zm11-3c0 2.5-.2 4.1-.44 5.08-.24.97-.97 1.7-1.94 1.94C17.64 19.25 12 19.25 12 19.25s-5.64 0-6.62-.23c-.97-.24-1.7-.97-1.94-1.94C3.2 16.1 3 14.5 3 12s.2-4.1.44-5.08c.24-.97.97-1.7 1.94-1.94C6.36 4.75 12 4.75 12 4.75s5.64 0 6.62.23c.97.24 1.7.97 1.94 1.94.24.98.44 2.58.44 5.08z"/></svg>
            Open on YouTube
          </a>
          <button class="btn btn-secondary" id="copyLinkBtn" data-url="{{ request.url }}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Copy link
          </button>
          <a class="btn btn-secondary" href="/tracks">Back to Tracks</a>
        </div>
      </div>

      <!-- Properties -->
      <div class="grid section grid-1col">
        <div class="card">
          <h3 class="section-title">File Properties</h3>
          <div class="kv">
            <div class="muted">Title (file)</div><div>{{ track.get('name') or '-' }}</div>
            <div class="muted">Duration</div><div>{% if track.get('duration') %}{{ (track['duration'] // 60)|int }}:{{ ('%02d' % (track['duration'] % 60)) }}{% else %}-{% endif %}</div>
            <div class="muted">Size</div><div>{% if track.get('size_bytes') is not none %}{{ '%.1f' % (track['size_bytes']/1048576) }} MB{% else %}-{% endif %}</div>
            <div class="muted">Video</div>
            <div id="videoSummaryValue">
              <span id="videoSummaryText">
                {% set parts = [] %}
                {% if track.get('video_codec') %}{% set _ = parts.append(track.get('video_codec')) %}{% endif %}
                {% if track.get('resolution') %}{% set _ = parts.append(track.get('resolution')) %}{% endif %}
                {% if track.get('video_fps') %}{% set _ = parts.append(('%.2f' % track.get('video_fps')) + ' fps') %}{% endif %}
                {% if track.get('bitrate') %}{% set _ = parts.append(((track.get('bitrate')/1000)|int)|string + ' kbps') %}{% endif %}
                {{ parts|length and (' Â· '.join(parts)) or '-' }}
              </span>
              <button id="rescanMediaBtn" class="inline-action" title="Rescan media properties" style="margin-left:8px; padding:2px 8px; font-size:12px;">âŸ² Rescan</button>
            </div>
            <div class="muted">Audio</div>
            <div id="audioInfoValue">
              {% set audio_parts = [] %}
              {% if track.get('audio_codec') %}{% set _ = audio_parts.append(track.get('audio_codec').upper()) %}{% endif %}
              {% if track.get('audio_bitrate') %}{% set _ = audio_parts.append(((track.get('audio_bitrate')/1000)|int)|string + ' kbps') %}{% elif track.get('audio_codec') %}{% set _ = audio_parts.append('VBR') %}{% endif %}
              {% if track.get('audio_sample_rate') %}{% set _ = audio_parts.append(('%.1f' % (track.get('audio_sample_rate')/1000.0)) + ' kHz') %}{% endif %}
              {{ ' Â· '.join(audio_parts) if audio_parts else '-' }}
            </div>
            <div class="muted">Type</div><div>{{ track.get('filetype') or '-' }}</div>
            <div class="muted">Relpath</div><div class="mono">{{ track.get('relpath') or '-' }}</div>
            <div class="muted">Files with this ID</div>
            <div>
              {% if same_id_count and same_id_count > 0 %}
                <span class="mono">{{ same_id_count }}</span>
                {% if same_id_files_info and same_id_files_info|length > 0 %}
                  <details style="margin-top:4px;">
                    <summary class="muted">Show files</summary>
                    <table class="mono" style="margin-top:6px; width:100%; font-size:12px;">
                      <thead>
                        <tr>
                          <th style="text-align:left; padding-right:8px;">Path</th>
                          <th style="text-align:right; padding-right:8px;">Size</th>
                          <th style="text-align:left;">Modified</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for info in same_id_files_info %}
                          <tr>
                            <td style="padding-right:8px;"><a href="/media/{{ info.rel }}" target="_blank" rel="noopener">{{ info.rel }}</a></td>
                            <td style="text-align:right; padding-right:8px; white-space:nowrap;">{{ info.size_human }}</td>
                            <td style="white-space:nowrap;">{{ info.modified }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </details>
                {% endif %}
              {% else %}
                <span class="muted">0</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="section-title">Usage Stats</h3>
          <div class="kv">
            <div class="muted">Starts</div><div>{{ track.get('play_starts') or 0 }}</div>
            <div class="muted">Finishes</div><div>{{ track.get('play_finishes') or 0 }}</div>
            <div class="muted">Nexts</div><div>{{ track.get('play_nexts') or 0 }}</div>
            <div class="muted">Prevs</div><div>{{ track.get('play_prevs') or 0 }}</div>
            <div class="muted">Likes</div><div>{{ track.get('play_likes') or 0 }}</div>
            <div class="muted">Last Start</div><div>{{ track.get('last_start_ts') or '-' }}</div>
            <div class="muted">Last Finish</div><div>{{ track.get('last_finish_ts') or '-' }}</div>
          </div>
        </div>
      </div>

      <!-- Playlists -->
      {% set names = track.get('playlists_list') or [] %}
      {% set rels = track.get('playlist_relpaths_list') or [] %}
      {% set has_pl = names and rels and (names|length == rels|length) %}
      {% set has_pl_text = track.get('playlists') %}
      {% if has_pl or has_pl_text %}
        <div class="card section">
          <h3 class="section-title">Playlists ({{ track.get('playlist_count') or 0 }})</h3>
          {% if has_pl %}
            <div class="list-inline">
              {% for i in range(names|length) %}
                <a class="pill" href="/playlist/{{ rels[i] }}">{{ names[i] }}</a>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">{{ track['playlists'] }}</div>
          {% endif %}
        </div>
      {% endif %}

      <!-- YouTube Metadata -->
      <div class="card section">
        <h3 class="section-title">YouTube Metadata</h3>
        {% if metadata %}
          <div class="kv">
            <div class="muted">Title (YouTube)</div><div>{{ metadata['title'] or '-' }}</div>
            <div class="muted">Duration</div><div>{{ metadata['duration_string'] or metadata['duration'] or '-' }}</div>
            <div class="muted">Channel</div><div>{{ metadata['channel'] or '-' }}</div>
            <div class="muted">Uploader</div><div>{{ metadata['uploader'] or '-' }}</div>
            <div class="muted">Release</div><div>{{ metadata['release_timestamp'] or metadata['timestamp'] or '-' }}</div>
            <div class="muted">Availability</div><div>{{ metadata['availability'] or '-' }}</div>
            <div class="muted">Live status</div><div>{{ metadata['live_status'] or '-' }}</div>
          </div>
          {% if metadata['description'] %}
            <details style="margin-top:10px;">
              <summary class="muted">Description</summary>
              <div class="description">{{ metadata['description'] }}</div>
            </details>
          {% endif %}
        {% else %}
          <div class="muted">No YouTube metadata found for this track.</div>
        {% endif %}
      </div>

      <!-- YouTube Qualities -->
      <div class="card section" id="ytQualitiesSection">
        <h3 class="section-title">YouTube Qualities</h3>
        <div class="kv">
          <div class="muted">Summary</div>
          <div>
            <span id="ytQualitiesSummary">{% if metadata and metadata.get('available_qualities_summary') %}{{ metadata['available_qualities_summary'] }}{% else %}-{% endif %}</span>
            <button id="rescanYoutubeBtn" class="inline-action" title="Rescan YouTube metadata" style="margin-left:8px; padding:2px 8px; font-size:12px;">âŸ² Rescan YouTube</button>
            <button id="refreshYoutubeBtn" class="inline-action" title="Refresh from database" style="margin-left:6px; padding:2px 8px; font-size:12px;">â†» Refresh</button>
          </div>
        </div>
        <div id="ytFormatsToolbar" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;"></div>
        <details style="margin-top:8px;">
          <summary class="muted">Show details</summary>
          <div id="ytFormatsContainer" class="mono" style="margin-top:6px; font-size:12px; white-space:pre-wrap;"></div>
        </details>
      </div>

      <!-- Optional Raw Data (for debugging) -->
      <details class="section">
        <summary class="muted">Show raw data</summary>
        <div class="card">
          <div class="section-title">Track (DB)</div>
          <pre class="description">{{ track | tojson(indent=2) }}</pre>
        </div>
        {% if metadata %}
        <div class="card" style="margin-top:10px;">
          <div class="section-title">YouTube Metadata</div>
          <pre class="description">{{ metadata | tojson(indent=2) }}</pre>
        </div>
        {% endif %}
      </details>

    </div>
  </div>

  <script src="/static/js/modules/toast-notifications.js"></script>
  <script>
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.toggle('open');
    }
    document.addEventListener('click', function(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      if (window.innerWidth <= 768 && sidebar && !sidebar.contains(event.target) && !menuBtn.contains(event.target) && sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });
    const copyBtn = document.getElementById('copyLinkBtn');
    copyBtn?.addEventListener('click', async () => {
      try {
        const url = copyBtn.getAttribute('data-url') || window.location.href;
        await navigator.clipboard.writeText(url);
        copyBtn.textContent = 'Copied!';
        setTimeout(()=>{ copyBtn.textContent = 'Copy link'; }, 1200);
      } catch (e) { /* no-op */ }
    });

    // Rescan media properties
    const rescanBtn = document.getElementById('rescanMediaBtn');
    rescanBtn?.addEventListener('click', async () => {
      const btn = rescanBtn;
      const origText = btn.textContent;
      try {
        btn.disabled = true;
        btn.textContent = 'Rescanningâ€¦';
        const resp = await fetch(`/api/track/{{ video_id }}/rescan_media`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh_duration: false, refresh_size: false })
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== 'ok') {
          btn.textContent = 'Failed';
          window.ToastNotifications?.showToast(data?.error || 'Rescan failed', { position: 'bottom' });
          setTimeout(()=>{ btn.textContent = origText; btn.disabled = false; }, 1200);
          return;
        }
        // Update inline values if present
        const videoSummaryEl = document.getElementById('videoSummaryText');
        const resEl = document.getElementById('resolutionValue');
        const fpsEl = document.getElementById('fpsValue');
        const codecEl = document.getElementById('codecValue');
        const audioEl = document.getElementById('audioInfoValue');
        if (videoSummaryEl) {
          const parts = [];
          if (data.video_codec) parts.push(String(data.video_codec));
          if (data.resolution) parts.push(String(data.resolution));
          if (typeof data.video_fps === 'number' && data.video_fps > 0) {
            const fps = (Math.round(data.video_fps * 100) / 100).toFixed(2);
            parts.push(`${fps} fps`);
          }
          if (typeof data.bitrate === 'number' && data.bitrate > 0) {
            const kbps = Math.round(data.bitrate / 1000);
            parts.push(`${kbps} kbps`);
          }
          videoSummaryEl.textContent = parts.length ? parts.join(' Â· ') : '-';
        }
        if (audioEl) {
          const ap = [];
          if (data.audio_codec) ap.push(String(data.audio_codec).toUpperCase());
          if (typeof data.audio_bitrate === 'number' && data.audio_bitrate > 0) {
            ap.push(`${Math.round(data.audio_bitrate / 1000)} kbps`);
          } else if (data.audio_codec) {
            // If bitrate not available but codec present, show ~ kbps (est) when flagged; otherwise VBR
            if (data.audio_bitrate_estimated) {
              ap.push('~ kbps (est)');
            } else {
              ap.push('VBR');
            }
          }
          if (typeof data.audio_sample_rate === 'number' && data.audio_sample_rate > 0) {
            const khz = (Math.round(data.audio_sample_rate / 100) / 10).toFixed(1);
            ap.push(`${khz} kHz`);
          }
          audioEl.textContent = ap.length ? ap.join(' Â· ') : '-';
        }
        btn.textContent = 'Done';
        window.ToastNotifications?.showToast('Rescan complete', { position: 'bottom' });
        setTimeout(()=>{ btn.textContent = origText; btn.disabled = false; }, 800);
      } catch (e) {
        btn.textContent = 'Error';
        window.ToastNotifications?.showToast('Unexpected error', { position: 'bottom' });
        setTimeout(()=>{ btn.textContent = origText; btn.disabled = false; }, 1200);
      }
    });

    // YouTube Qualities: helpers
    const ytSummaryEl = document.getElementById('ytQualitiesSummary');
    const ytFormatsEl = document.getElementById('ytFormatsContainer');
    const ytToolbarEl = document.getElementById('ytFormatsToolbar');
    const ytRescanBtn = document.getElementById('rescanYoutubeBtn');
    const ytRefreshBtn = document.getElementById('refreshYoutubeBtn');

    let allFormats = [];
    let normalized = [];
    const filterState = {
      type: 'all',       // all | video | audio | progressive | no_storyboard
      container: 'all',  // all | mp4 | webm
      codec: 'all'       // all | avc1 | vp9 | av01
    };

    async function fetchYoutubeFormats() {
      try {
        ytRefreshBtn && (ytRefreshBtn.disabled = true);
        const resp = await fetch(`/api/track/{{ video_id }}/youtube_formats`);
        const data = await resp.json();
        if (!resp.ok || data.status !== 'ok') {
          window.ToastNotifications?.showToast(data?.error || 'Failed to load YouTube formats', { position: 'bottom' });
          return;
        }
        const summary = data.available_qualities_summary || '-';
        if (ytSummaryEl) ytSummaryEl.textContent = summary;
        allFormats = Array.isArray(data.available_formats) ? data.available_formats : [];
        normalized = normalizeFormats(allFormats);
        renderToolbar();
        renderList(normalized);
      } catch (e) {
        window.ToastNotifications?.showToast('Unexpected error loading YouTube formats', { position: 'bottom' });
      } finally {
        ytRefreshBtn && (ytRefreshBtn.disabled = false);
      }
    }

    async function requestRedownload(formatId) {
      try {
        const resp = await fetch(`/api/track/{{ video_id }}/redownload`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ format_id: formatId })
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== 'started') {
          window.ToastNotifications?.showToast(data?.error || 'Failed to enqueue redownload', { position: 'bottom' });
          return;
        }
        window.ToastNotifications?.showToast(`Redownload job #${data.job_id} started`, { position: 'bottom' });
      } catch (e) {
        window.ToastNotifications?.showToast('Unexpected error enqueuing redownload', { position: 'bottom' });
      }
    }

    function normalizeFormats(formats) {
      return (formats || []).map((f) => {
        const vcodec = (f.vcodec || '').toLowerCase();
        const acodec = (f.acodec || '').toLowerCase();
        const ext = (f.ext || '').toLowerCase();
        const note = (f.format_note || '').toLowerCase();
        const isStoryboard = ext === 'mhtml' || note.includes('storyboard');
        const hasVideo = vcodec && vcodec !== 'none';
        const hasAudio = acodec && acodec !== 'none';
        let type = 'other';
        if (isStoryboard) type = 'storyboard';
        else if (hasVideo && hasAudio) type = 'progressive';
        else if (hasVideo && !hasAudio) type = 'video';
        else if (!hasVideo && hasAudio) type = 'audio';
        return {
          id: f.format_id || '',
          height: f.height || null,
          fps: f.fps ? Math.round(f.fps) : null,
          vcodec, acodec, ext,
          abr: (typeof f.abr === 'number' && f.abr > 0) ? Math.round(f.abr) : (typeof f.tbr === 'number' ? Math.round(f.tbr) : null),
          asr: f.asr ? Math.round(f.asr) : null,
          note: f.format_note || '',
          type,
        };
      });
    }

    function passesFilters(f) {
      if (f.type === 'storyboard') return false;
      if (filterState.type !== 'all') {
        if (filterState.type === 'video' && f.type !== 'video') return false;
        if (filterState.type === 'audio' && f.type !== 'audio') return false;
        if (filterState.type === 'progressive' && f.type !== 'progressive') return false;
      }
      if (filterState.container !== 'all' && f.ext !== filterState.container) return false;
      if (filterState.codec !== 'all') {
        const c = filterState.codec;
        if (!f.vcodec.includes(c) && !f.acodec.includes(c)) return false;
      }
      return true;
    }

    function renderToolbar() {
      if (!ytToolbarEl) return;
      ytToolbarEl.innerHTML = `
        <span class="muted" style="font-size:12px;">Filters:</span>
        <button class="inline-action format-action" data-ftype="all">All</button>
        <button class="inline-action format-action" data-ftype="video">Video-only</button>
        <button class="inline-action format-action" data-ftype="audio">Audio-only</button>
        <button class="inline-action format-action" data-ftype="progressive">Progressive</button>
        <span class="muted" style="font-size:12px; margin-left:8px;">Container:</span>
        <button class="inline-action format-action" data-fcontainer="all">All</button>
        <button class="inline-action format-action" data-fcontainer="mp4">MP4</button>
        <button class="inline-action format-action" data-fcontainer="webm">WEBM</button>
        <span class="muted" style="font-size:12px; margin-left:8px;">Codec:</span>
        <button class="inline-action format-action" data-fcodec="all">All</button>
        <button class="inline-action format-action" data-fcodec="avc1">H.264</button>
        <button class="inline-action format-action" data-fcodec="vp9">VP9</button>
        <button class="inline-action format-action" data-fcodec="av01">AV1</button>
      `;
      ytToolbarEl.querySelectorAll('button[data-ftype]')?.forEach(btn => {
        btn.addEventListener('click', () => { filterState.type = btn.getAttribute('data-ftype'); renderList(normalized); });
      });
      ytToolbarEl.querySelectorAll('button[data-fcontainer]')?.forEach(btn => {
        btn.addEventListener('click', () => { filterState.container = btn.getAttribute('data-fcontainer'); renderList(normalized); });
      });
      ytToolbarEl.querySelectorAll('button[data-fcodec]')?.forEach(btn => {
        btn.addEventListener('click', () => { filterState.codec = btn.getAttribute('data-fcodec'); renderList(normalized); });
      });
    }

    function renderList(nf) {
      if (!ytFormatsEl) return;
      const filtered = nf.filter(passesFilters);
      const maxLines = 80;
      const rows = [];
      for (let i=0; i<filtered.length && i<maxLines; i++) {
        const f = filtered[i];
        const parts = [];
        if (f.height) parts.push(`${f.height}p`);
        if (f.fps) parts.push(`${f.fps}fps`);
        if (f.vcodec) parts.push(f.vcodec);
        if (f.acodec && f.type!=='video') parts.push(f.acodec);
        if (f.abr) parts.push(`${f.abr}kbps`);
        parts.push(f.ext);
        if (f.note) parts.push(f.note);
        const label = parts.join(' Â· ');
        rows.push(`<div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
          <span>- ${f.id}: ${label}</span>
          <button class="inline-action format-action" data-fid="${f.id}">Download this quality</button>
        </div>`);
      }
      if (filtered.length > maxLines) rows.push(`<div class="muted">â€¦ and ${filtered.length - maxLines} more</div>`);
      ytFormatsEl.innerHTML = rows.join('');
      ytFormatsEl.querySelectorAll('button[data-fid]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const fid = btn.getAttribute('data-fid');
          if (fid) requestRedownload(fid);
        });
      });
    }

    ytRefreshBtn?.addEventListener('click', fetchYoutubeFormats);

    ytRescanBtn?.addEventListener('click', async () => {
      const btn = ytRescanBtn;
      const orig = btn.textContent;
      try {
        btn.disabled = true;
        btn.textContent = 'Enqueuingâ€¦';
        const resp = await fetch(`/api/track/{{ video_id }}/rescan_youtube_metadata`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force_update: true })
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== 'started') {
          btn.textContent = 'Failed';
          window.ToastNotifications?.showToast(data?.error || 'Failed to enqueue', { position: 'bottom' });
          setTimeout(()=>{ btn.textContent = orig; btn.disabled = false; }, 1200);
          return;
        }
        btn.textContent = 'Queued';
        window.ToastNotifications?.showToast(`Job #${data.job_id} started`, { position: 'bottom' });
        setTimeout(()=>{ btn.textContent = orig; btn.disabled = false; }, 1000);
      } catch (e) {
        btn.textContent = 'Error';
        window.ToastNotifications?.showToast('Unexpected error', { position: 'bottom' });
        setTimeout(()=>{ btn.textContent = orig; btn.disabled = false; }, 1200);
      }
    });

    // Initial load of YouTube formats: always fetch to populate details
    (function initYoutubeQualities() {
      fetchYoutubeFormats();
    })();
  </script>
</body>
</html>
