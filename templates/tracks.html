<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Library - YouTube Player</title>
  <!-- Favicon using emoji -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéµ</text></svg>">
  
  <!-- Include Sidebar Styles -->
  {% include 'sidebar_styles.html' %}
  
  <!-- Include Tracks Page Styles -->
  <link rel="stylesheet" href="/static/css/tracks.css">
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  
  <div class="layout">
    <!-- Include Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">Track Library</h1>
        <div class="header-actions">
          <button id="restartBtn" class="btn btn-warning">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M8 16H3v5"/>
            </svg>
            Restart
          </button>
        </div>
      </div>
      
      <!-- Search Section -->
      <div class="search-section">
        <form method="GET" action="/tracks" class="search-form">
          <input 
            type="text" 
            name="search" 
            value="{{ search_query or '' }}" 
            placeholder="Search tracks by title..." 
            class="search-input"
          />
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              name="include_deleted" 
              value="1" 
              {% if include_deleted %}checked{% endif %}
              onchange="this.form.submit()"
            />
            <span class="checkbox-text">Show deleted tracks</span>
          </label>
          <button type="submit" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            Search
          </button>
          {% if search_query or include_deleted %}
          <a href="/tracks" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Clear
          </a>
          {% endif %}
        </form>
        
        {% if search_query %}
        <div class="search-results">
          Search results for: <span class="search-query">"{{ search_query }}"</span>
        </div>
        {% endif %}

        <!-- Filters Panel -->
        <div class="filters-panel {% if not filters.applied %}collapsed{% endif %}">
          <div class="filters-header">
            <h3>Filters</h3>
            <div class="filters-actions">
              <button type="button" class="btn btn-secondary btn-sm" id="toggleFiltersBtn">Show Filters</button>
              {% if filters.applied %}
                <span class="filters-applied-indicator">Filters applied</span>
              {% endif %}
              <!-- Clear Filters: preserve search/include_deleted if present -->
              <a class="btn btn-secondary btn-sm" href="/tracks{% if search_query or include_deleted %}?{% endif %}{% if search_query %}search={{ search_query | urlencode }}{% endif %}{% if search_query and include_deleted %}&{% endif %}{% if include_deleted %}include_deleted=1{% endif %}">Clear Filters</a>
            </div>
          </div>

          <form method="GET" action="/tracks" class="filters-form">
            <!-- Preserve existing search and include_deleted state -->
            {% if search_query %}
              <input type="hidden" name="search" value="{{ search_query }}" />
            {% endif %}
            {% if include_deleted %}
              <input type="hidden" name="include_deleted" value="1" />
            {% endif %}

            <div class="filters-groups">
              <!-- Resolutions facet -->
              <div class="filters-group">
                <h4>Resolution</h4>
                <div class="filters-controls">
                  <button type="button" class="btn btn-secondary btn-sm" id="selectAllResBtn">Select All</button>
                  <button type="button" class="btn btn-secondary btn-sm" id="clearResBtn">Clear</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-preset="2160p">2160p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-preset="1440p">1440p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-preset="1080p">1080p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-preset="lte720p">‚â§ 720p</button>
                  <button type="button" class="btn btn-secondary btn-sm" id="toggleResolutionsBtn" style="display:none;">Show more</button>
                </div>
                <div class="filters-summary" id="resSummary"></div>
                <div class="filters-checkboxes" id="resolutionsContainer">
                  {% for res in facets.resolutions %}
                    <label class="checkbox-label">
                      <input type="checkbox" name="resolution[]" value="{{ res }}" {% if filters.resolutions and res in filters.resolutions %}checked{% endif %}>
                      <span class="checkbox-text">{{ res }}{% if facets.resolution_counts and facets.resolution_counts.get(res) %} ({{ facets.resolution_counts.get(res) }}){% endif %}</span>
                    </label>
                  {% endfor %}
                  {% if not facets.resolutions %}
                    <div class="empty-state" style="padding:8px 0;">No resolution data</div>
                  {% endif %}
                </div>
              </div>

              <!-- Likes threshold -->
              <div class="filters-group">
                <h4>Minimum Likes</h4>
                <div class="filters-field">
                  <input type="number" name="min_likes" min="0" step="1" placeholder="0" class="number-input" value="{{ filters.min_likes }}" />
                </div>
              </div>

              <!-- Duration range (seconds) -->
              <div class="filters-group">
                <h4>Duration (sec)</h4>
                <div class="filters-field" style="display:flex; gap:8px; align-items:center;">
                  <input type="number" name="min_duration" min="0" step="1" placeholder="Min" class="number-input" value="{{ filters.min_duration }}" />
                  <span style="color:var(--text-secondary);">‚Äì</span>
                  <input type="number" name="max_duration" min="0" step="1" placeholder="Max" class="number-input" value="{{ filters.max_duration }}" />
                </div>
              </div>

              <!-- Bitrate range (kbps) -->
              <div class="filters-group">
                <h4>Bitrate (kbps)</h4>
                <div class="filters-field" style="display:flex; gap:8px; align-items:center;">
                  <input type="number" name="min_bitrate_kbps" min="0" step="1" placeholder="Min" class="number-input" value="{{ filters.min_bitrate_kbps }}" />
                  <span style="color:var(--text-secondary);">‚Äì</span>
                  <input type="number" name="max_bitrate_kbps" min="0" step="1" placeholder="Max" class="number-input" value="{{ filters.max_bitrate_kbps }}" />
                </div>
              </div>

              <!-- Size range (MB) -->
              <div class="filters-group">
                <h4>Size (MB)</h4>
                <div class="filters-field" style="display:flex; gap:8px; align-items:center;">
                  <input type="number" name="min_size_mb" min="0" step="0.1" placeholder="Min" class="number-input" value="{{ filters.min_size_mb }}" />
                  <span style="color:var(--text-secondary);">‚Äì</span>
                  <input type="number" name="max_size_mb" min="0" step="0.1" placeholder="Max" class="number-input" value="{{ filters.max_size_mb }}" />
                </div>
              </div>

              <!-- File Types facet -->
              <div class="filters-group">
                <h4>File Type</h4>
                <div class="filters-checkboxes">
                  {% for ft in facets.filetypes %}
                    <label class="checkbox-label">
                      <input type="checkbox" name="filetype[]" value="{{ ft }}" {% if filters.filetypes and ft in filters.filetypes %}checked{% endif %}>
                      <span class="checkbox-text">{{ ft }}{% if facets.filetype_counts and facets.filetype_counts.get(ft.lower()) %} ({{ facets.filetype_counts.get(ft.lower()) }}){% endif %}</span>
                    </label>
                  {% endfor %}
                  {% if not facets.filetypes %}
                    <div class="empty-state" style="padding:8px 0;">No file type data</div>
                  {% endif %}
                </div>
              </div>

              <!-- Max YouTube Quality filter (server-side) -->
              <div class="filters-group">
                <h4>Max YouTube Quality</h4>
                <input type="hidden" name="min_max_quality" id="minMaxQualityInput" value="{{ filters.min_max_quality }}" />
                <div class="filters-controls" id="maxQualityControls">
                  <button type="button" class="btn btn-secondary btn-sm" data-q="">All</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-q="2160">‚â• 2160p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-q="1440">‚â• 1440p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-q="1080">‚â• 1080p</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-q="720">‚â• 720p</button>
                </div>
                <div class="filters-summary" id="maxQualitySummary"></div>
              </div>
            </div>

            <div class="filters-footer">
              <button type="submit" class="btn btn-primary">Apply Filters</button>
              {% if filters.applied %}
                <span class="filters-applied-indicator">Filters applied</span>
              {% endif %}
            </div>
          </form>
        </div>
        
        <!-- Column Visibility Panel -->
        <div class="columns-panel collapsed">
          <div class="columns-header">
            <h3>Columns</h3>
            <div class="column-actions">
              <button type="button" id="toggleColumnsBtn" class="btn btn-secondary btn-sm">Show Columns</button>
              <button type="button" id="selectAllColumns" class="btn btn-secondary btn-sm">Select All</button>
              <button type="button" id="resetColumns" class="btn btn-secondary btn-sm">Reset to Defaults</button>
            </div>
          </div>
          
          <div class="columns-groups">
            <!-- Core Columns -->
            <div class="column-group">
              <h4>Core</h4>
              <div class="column-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" data-col="index" checked disabled>
                  <span class="checkbox-text">#</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="title" checked disabled>
                  <span class="checkbox-text">Title</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="video_id">
                  <span class="checkbox-text">Video ID</span>
                </label>
              </div>
            </div>
            
            <!-- Media Columns -->
            <div class="column-group">
              <h4>Media</h4>
              <div class="column-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" data-col="playlists">
                  <span class="checkbox-text">Playlists</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="duration" checked>
                  <span class="checkbox-text">Duration</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="size">
                  <span class="checkbox-text">Size</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="bitrate">
                  <span class="checkbox-text">Bitrate</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="resolution">
                  <span class="checkbox-text">Resolution</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="max_quality">
                  <span class="checkbox-text">Max YouTube Quality</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="type">
                  <span class="checkbox-text">Type</span>
                </label>
              </div>
            </div>
            
            <!-- Stats Columns -->
            <div class="column-group">
              <h4>Stats</h4>
              <div class="column-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" data-col="starts">
                  <span class="checkbox-text">Starts</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="finishes">
                  <span class="checkbox-text">Finishes</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="nexts">
                  <span class="checkbox-text">Nexts</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="prevs">
                  <span class="checkbox-text">Prevs</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="likes">
                  <span class="checkbox-text">Likes</span>
                </label>
              </div>
            </div>
            
            <!-- Activity/Status Columns -->
            <div class="column-group">
              <h4>Activity / Status</h4>
              <div class="column-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" data-col="last_start">
                  <span class="checkbox-text">Last Start</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="last_finish">
                  <span class="checkbox-text">Last Finish</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" data-col="deleted">
                  <span class="checkbox-text">Deleted</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tracks Table -->
      <div class="table-container">
        <table id="trackTable">
          <thead>
            <tr>
              <th data-col="index" class="col col-index">#</th>
              <th data-col="title" class="col col-title">Title</th>
              <th data-col="video_id" class="col col-video_id">Video ID</th>
              <th data-col="playlists" class="col col-playlists">Playlists</th>
              <th data-col="duration" class="col col-duration">Duration</th>
              <th data-col="size" class="col col-size">Size</th>
              <th data-col="bitrate" class="col col-bitrate">Bitrate</th>
              <th data-col="resolution" class="col col-resolution">Resolution</th>
              <th data-col="max_quality" class="col col-max_quality">Max YouTube Quality</th>
              <th data-col="type" class="col col-type">Type</th>
              <th data-col="starts" class="col col-starts">Starts</th>
              <th data-col="finishes" class="col col-finishes">Finishes</th>
              <th data-col="nexts" class="col col-nexts">Nexts</th>
              <th data-col="prevs" class="col col-prevs">Prevs</th>
              <th data-col="likes" class="col col-likes">Likes</th>
              <th data-col="last_start" class="col col-last_start">Last Start</th>
              <th data-col="last_finish" class="col col-last_finish">Last Finish</th>
              <th data-col="deleted" class="col col-deleted">Deleted</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tracks %}
              <tr class="{% if t['is_deleted'] %}track-deleted{% endif %}">
                <td data-col="index" class="col col-index">{{ loop.index }}</td>
                <td data-col="title" class="col col-title">
                  <a href="/track/{{ t['video_id'] }}" class="track-link">{{ t['display_name'] }}</a>
                </td>
                <td data-col="video_id" class="col col-video_id">
                  <a href="/track/{{ t['video_id'] }}" class="track-link mono">{{ t['video_id'] }}</a>
                  <a href="https://youtu.be/{{ t['video_id'] }}" target="_blank" rel="noopener" title="Open on YouTube" style="margin-left:6px;">üîó</a>
                </td>
                <td data-col="playlists" class="col col-playlists">{{ t['playlists'] or '-' }}</td>
                <td data-col="duration" class="col col-duration">{% if t['duration'] %}{{ (t['duration'] // 60)|int }}:{{ ('%02d' % (t['duration'] % 60)) }}{% else %}-{% endif %}</td>
                <td data-col="size" class="col col-size">{{ '%.1f' % (t['size_bytes']/1048576) }} MB</td>
                <td data-col="bitrate" class="col col-bitrate">{% if t['bitrate'] %}{{ (t['bitrate']/1000)|int }} kbps{% else %}-{% endif %}</td>
                <td data-col="resolution" class="col col-resolution">{{ t['resolution'] or '-' }}</td>
                <td data-col="max_quality" class="col col-max_quality">{{ max_quality_map.get(t['video_id'], '-') }}</td>
                <td data-col="type" class="col col-type">{{ t['filetype'] }}</td>
                <td data-col="starts" class="col col-starts">{{ t['play_starts'] }}</td>
                <td data-col="finishes" class="col col-finishes">{{ t['play_finishes'] }}</td>
                <td data-col="nexts" class="col col-nexts">{{ t['play_nexts'] }}</td>
                <td data-col="prevs" class="col col-prevs">{{ t['play_prevs'] }}</td>
                <td data-col="likes" class="col col-likes">{{ t['play_likes'] }}</td>
                <td data-col="last_start" class="col col-last_start">{{ t['last_start_ts'] or '-' }}</td>
                <td data-col="last_finish" class="col col-last_finish">{{ t['last_finish_ts'] or '-' }}</td>
                <td data-col="deleted" class="col col-deleted">
                  {% if t['is_deleted'] %}
                    <span class="deleted-status deleted" title="Deleted on {{ t['deleted_date'] }} ({{ t['deletion_reason'] }})">
                      ‚ùå Deleted
                    </span>
                  {% else %}
                    <span class="deleted-status active">
                      ‚úÖ Active
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="17" class="empty-state">
                  Database is empty. Run <code>python scan_to_db.py</code> first.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if pagination and pagination.total > pagination.per_page %}
        <div class="pagination">
          {% set total_pages = (pagination.total // pagination.per_page) + (1 if (pagination.total % pagination.per_page) else 0) %}
          <div class="pagination-info">Page {{ pagination.page }} of {{ total_pages }} ‚Äî {{ pagination.total }} items</div>
          <div class="pagination-controls">
            {% set prev_page = pagination.page - 1 %}
            {% set next_page = pagination.page + 1 %}
            {% set has_q = '?' in request.full_path %}
            {% set has_page_param = 'page=' in request.full_path %}
            {% if pagination.page > 1 %}
              {% if has_page_param %}
                {% set prev_url = request.full_path | replace('page=' ~ pagination.page, 'page=' ~ prev_page) %}
              {% else %}
                {% set prev_url = request.full_path ~ ('&' if has_q else '?') ~ 'page=' ~ prev_page %}
              {% endif %}
              <a class="btn btn-secondary btn-sm" href="{{ prev_url }}">Prev</a>
            {% endif %}
            {% if pagination.page < total_pages %}
              {% if has_page_param %}
                {% set next_url = request.full_path | replace('page=' ~ pagination.page, 'page=' ~ next_page) %}
              {% else %}
                {% set next_url = request.full_path ~ ('&' if has_q else '?') ~ 'page=' ~ next_page %}
              {% endif %}
              <a class="btn btn-secondary btn-sm" href="{{ next_url }}">Next</a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // Mobile sidebar toggle
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('open');
    }
    
    // Ensure search query with special chars (e.g., #) is properly encoded on submit
    (function(){
      const form = document.querySelector('.search-form');
      if(!form) return;
      form.addEventListener('submit', function(e){
        try{
          const params = new URLSearchParams(new FormData(form));
          const url = '/tracks?' + params.toString();
          e.preventDefault();
          window.location.assign(url);
        }catch(err){
          // Fallback to default form submit if URLSearchParams is unavailable
        }
      });
    })();
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      
      if (window.innerWidth <= 768 && 
          !sidebar.contains(event.target) && 
          !menuBtn.contains(event.target) && 
          sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });

    // Table sorting functionality (preserved from original)
    (function(){
      const table = document.getElementById('trackTable');
      if(!table) return;
      const tbody = table.querySelector('tbody');

      function parseValue(text){
        const trimmed = text.trim();
        // date
        if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(trimmed)){
          return new Date(trimmed.replace(' ', 'T'));
        }
        // numeric
        const num = parseFloat(trimmed.replace(/[^0-9.\-]/g,''));
        if(!isNaN(num) && /[0-9]/.test(trimmed)) return num;
        return trimmed.toLowerCase();
      }

      let currentIdx = 0;
      let currentAsc = true;

      function updateIndicators(){
        table.querySelectorAll('thead th').forEach((h,i)=>{
           const span=h.querySelector('.arrow'); if(span) span.remove();
           if(i===currentIdx){
              const arrow=document.createElement('span');
              arrow.className='arrow';
              arrow.textContent=currentAsc?'‚ñ≤':'‚ñº';
              h.appendChild(arrow);
           }
        });
      }

      function sortBy(idx, asc){
         const rows = Array.from(tbody.querySelectorAll('tr'));
         rows.sort((a,b)=>{
            let v1 = a.children[idx].innerText.trim();
            let v2 = b.children[idx].innerText.trim();

            const empty1 = (v1==='-'||v1==='');
            const empty2 = (v2==='-'||v2==='');
            if(empty1 && empty2) return 0;
            if(empty1) return asc?1:-1; // empty always bottom on asc
            if(empty2) return asc?-1:1;

            v1 = parseValue(v1);
            v2 = parseValue(v2);

            if(v1>v2) return asc?1:-1;
            if(v1<v2) return asc?-1:1;
            return 0;
         });
         rows.forEach(r=>tbody.appendChild(r));
         currentIdx=idx; currentAsc=asc;
         updateIndicators();
      }

      table.querySelectorAll('thead th').forEach((th, idx)=>{
        th.style.cursor='pointer'; th.title='Sort';
        th.addEventListener('click',()=>{
            const asc = (currentIdx===idx)? !currentAsc : true;
            sortBy(idx, asc);
        });
      });

      // default sort by first column ascending
      sortBy(0, true);
    })();

    // Restart Server
    const restartBtn = document.getElementById('restartBtn');
    restartBtn?.addEventListener('click', async () => {
        if(!confirm('Are you sure you want to restart the server? This may interrupt current operations.')) return;
        restartBtn.disabled = true;
        restartBtn.innerHTML = '‚è≥ Restarting...';
        try{
            await fetch('/api/restart', {
                method:'POST',
                headers:{'Content-Type':'application/json'}
            });
            setTimeout(() => location.reload(), 4000);
        }catch(err){
            setTimeout(() => location.reload(), 4000);
        }
    });

    // Column Visibility Management
    (function() {
        const STORAGE_KEY = 'tracks_column_prefs_v1';
        
        // Default visibility by viewport width
        function getDefaultVisibility() {
            const width = window.innerWidth;
            if (width >= 1440) {
                return {
                    index: true, title: true, video_id: true, playlists: true, duration: true,
                    size: true, bitrate: true, resolution: true, max_quality: true, type: true, starts: true,
                    finishes: true, nexts: true, prevs: true, likes: true, last_start: true,
                    last_finish: true, deleted: true
                };
            } else if (width >= 1280) {
                return {
                    index: true, title: true, video_id: true, playlists: true, duration: true,
                    size: true, bitrate: true, resolution: true, max_quality: true, type: true, starts: false,
                    finishes: false, nexts: false, prevs: false, likes: false, last_start: false,
                    last_finish: false, deleted: true
                };
            } else if (width >= 1024) {
                return {
                    index: true, title: true, video_id: true, playlists: false, duration: true,
                    size: false, bitrate: false, resolution: true, max_quality: true, type: false, starts: false,
                    finishes: false, nexts: false, prevs: false, likes: false, last_start: false,
                    last_finish: false, deleted: false
                };
            } else {
                return {
                    index: true, title: true, video_id: false, playlists: false, duration: true,
                    size: false, bitrate: false, resolution: false, max_quality: false, type: false, starts: false,
                    finishes: false, nexts: false, prevs: false, likes: false, last_start: false,
                    last_finish: false, deleted: false
                };
            }
        }
        
        // Load preferences from localStorage or use defaults
        function loadPreferences() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('Failed to parse saved column preferences, using defaults');
                }
            }
            return getDefaultVisibility();
        }
        
        // Save preferences to localStorage
        function savePreferences(prefs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
        }
        
        // Apply column visibility to the table
        function applyColumnVisibility(prefs) {
            const table = document.getElementById('trackTable');
            if (!table) return;
            
            // Update headers
            table.querySelectorAll('thead th[data-col]').forEach(th => {
                const colKey = th.getAttribute('data-col');
                if (prefs[colKey]) {
                    th.classList.remove('hidden');
                } else {
                    th.classList.add('hidden');
                }
            });
            
            // Update body cells
            table.querySelectorAll('tbody td[data-col]').forEach(td => {
                const colKey = td.getAttribute('data-col');
                if (prefs[colKey]) {
                    td.classList.remove('hidden');
                } else {
                    td.classList.add('hidden');
                }
            });
            
            // Update checkboxes to match
            document.querySelectorAll('.columns-panel input[data-col]').forEach(checkbox => {
                const colKey = checkbox.getAttribute('data-col');
                checkbox.checked = prefs[colKey];
            });
        }
        
        // Initialize column visibility
        function initColumnVisibility() {
            const prefs = loadPreferences();
            applyColumnVisibility(prefs);
            
            // Wire up checkbox events
            document.querySelectorAll('.columns-panel input[data-col]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const colKey = this.getAttribute('data-col');
                    const isVisible = this.checked;
                    
                    // Prevent hiding both index and title
                    if (colKey === 'index' || colKey === 'title') {
                        if (!isVisible) {
                            const otherKey = colKey === 'index' ? 'title' : 'index';
                            const otherCheckbox = document.querySelector(`input[data-col="${otherKey}"]`);
                            if (!otherCheckbox.checked) {
                                this.checked = true;
                                return;
                            }
                        }
                    }
                    
                    prefs[colKey] = isVisible;
                    applyColumnVisibility(prefs);
                    savePreferences(prefs);
                });
            });
            
            // Wire up action buttons
            document.getElementById('selectAllColumns')?.addEventListener('click', function() {
                const allPrefs = {};
                document.querySelectorAll('.columns-panel input[data-col]').forEach(checkbox => {
                    const colKey = checkbox.getAttribute('data-col');
                    allPrefs[colKey] = true;
                });
                applyColumnVisibility(allPrefs);
                savePreferences(allPrefs);
            });
            
            document.getElementById('resetColumns')?.addEventListener('click', function() {
                const defaultPrefs = getDefaultVisibility();
                applyColumnVisibility(defaultPrefs);
                savePreferences(defaultPrefs);
            });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initColumnVisibility);
        } else {
            initColumnVisibility();
        }
        
        // Handle window resize to update defaults if no preferences are saved
        window.addEventListener('resize', function() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) {
                const defaultPrefs = getDefaultVisibility();
                applyColumnVisibility(defaultPrefs);
            }
        });
    })();

    // Filters: Resolutions helpers
    (function(){
      const container = document.getElementById('resolutionsContainer');
      if(!container) return;
      const selectAllBtn = document.getElementById('selectAllResBtn');
      const clearBtn = document.getElementById('clearResBtn');
      const presetBtns = document.querySelectorAll('[data-preset]');
      const toggleBtn = document.getElementById('toggleResolutionsBtn');
      const summaryEl = document.getElementById('resSummary');
      const COLLAPSE_AFTER = 12; // show first N, collapse the rest by default if many

      function getCheckboxes(){
        return Array.from(container.querySelectorAll('input[type="checkbox"][name="resolution[]"]'));
      }

      function selectAll(){
        getCheckboxes().forEach(cb=>cb.checked = true);
      }

      function clearAll(){
        getCheckboxes().forEach(cb=>cb.checked = false);
      }

      function applyPreset(tag){
        const cbs = getCheckboxes();
        // Start by clearing, then select matching ones
        cbs.forEach(cb=>cb.checked = false);
        cbs.forEach(cb=>{
          const val = String(cb.value || '');
          if(tag === '2160p' && /x2160$/i.test(val)) cb.checked = true;
          else if(tag === '1440p' && /x1440$/i.test(val)) cb.checked = true;
          else if(tag === '1080p' && /x1080$/i.test(val)) cb.checked = true;
          else if(tag === 'lte720p'){
            const parts = val.split('x');
            const h = parts.length === 2 ? parseInt(parts[1], 10) : NaN;
            if(!isNaN(h) && h <= 720) cb.checked = true;
          }
        });
      }

      function initCollapse(){
        const items = Array.from(container.querySelectorAll('.checkbox-label'));
        if(items.length <= COLLAPSE_AFTER){
          if(toggleBtn) toggleBtn.style.display = 'none';
          return;
        }
        let expanded = false;
        function update(){
          items.forEach((el, idx)=>{
            const cb = el.querySelector('input[type="checkbox"]');
            const isSelected = !!(cb && cb.checked);
            el.style.display = (expanded || idx < COLLAPSE_AFTER || isSelected) ? '' : 'none';
          });
          if(toggleBtn){
            toggleBtn.textContent = expanded ? 'Show less' : 'Show more';
            toggleBtn.style.display = '';
          }
        }
        update();
        if(toggleBtn){
          toggleBtn.addEventListener('click', ()=>{ expanded = !expanded; update(); });
        }
        // Expose updater so summary changes can re-evaluate visibility
        initCollapse.updateVisibility = update;
      }

      function updateSummary(){
        if(!summaryEl) return;
        const selected = getCheckboxes().filter(cb=>cb.checked).map(cb=>cb.value);
        if(selected.length === 0){
          summaryEl.textContent = 'No resolution selected';
          summaryEl.className = 'filters-summary';
        } else {
          const maxShow = 5;
          const shown = selected.slice(0, maxShow).join(', ');
          const more = selected.length - maxShow;
          summaryEl.textContent = more > 0 ? `Selected: ${shown} +${more} more` : `Selected: ${shown}`;
          summaryEl.className = 'filters-summary active';
        }
        // If collapse logic exists, re-apply to ensure selected remain visible
        if(typeof initCollapse.updateVisibility === 'function'){
          initCollapse.updateVisibility();
        }
      }

      selectAllBtn?.addEventListener('click', selectAll);
      clearBtn?.addEventListener('click', clearAll);
      presetBtns.forEach(btn=>{
        btn.addEventListener('click', ()=> { applyPreset(btn.getAttribute('data-preset')); updateSummary(); });
      });
      // Update summary on checkbox changes
      container.addEventListener('change', (e)=>{
        if(e.target && e.target.matches('input[type="checkbox"][name="resolution[]"]')){
          updateSummary();
        }
      });
      initCollapse();
      // Initial summary
      updateSummary();
    })();

    // Server-side Max YouTube Quality filter: set hidden field and submit form
    (function(){
      const controls = document.getElementById('maxQualityControls');
      const summary = document.getElementById('maxQualitySummary');
      const input = document.getElementById('minMaxQualityInput');
      const form = document.querySelector('.filters-form');
      if(!controls || !input || !form) return;

      function updateSummary(val){
        if(!summary) return;
        const v = (val||'').trim();
        summary.textContent = v ? (`Filtering by ‚â• ${v}p`) : 'All qualities';
        summary.className = 'filters-summary active';
      }

      controls.querySelectorAll('button[data-q]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.getAttribute('data-q') || '';
          input.value = v;
          updateSummary(v);
          form.submit();
        });
      });

      updateSummary(input.value);
    })();

    // Filters panel collapse toggle
    (function(){
      const panel = document.querySelector('.filters-panel');
      const btn = document.getElementById('toggleFiltersBtn');
      if(!panel || !btn) return;
      function updateLabel(){
        btn.textContent = panel.classList.contains('collapsed') ? 'Show Filters' : 'Hide Filters';
      }
      btn.addEventListener('click', ()=>{ panel.classList.toggle('collapsed'); updateLabel(); });
      updateLabel();
    })();

    // Columns panel collapse toggle
    (function(){
      const panel = document.querySelector('.columns-panel');
      const btn = document.getElementById('toggleColumnsBtn');
      if(!panel || !btn) return;
      function updateLabel(){
        btn.textContent = panel.classList.contains('collapsed') ? 'Show Columns' : 'Hide Columns';
      }
      btn.addEventListener('click', ()=>{ panel.classList.toggle('collapsed'); updateLabel(); });
      updateLabel();
    })();
  </script>
</body>
</html> 