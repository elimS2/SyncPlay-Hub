<!-- Database backups list page -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Backups - YouTube Player</title>
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸµ</text></svg>">
  
  <!-- Include Sidebar Styles -->
  {% include 'sidebar_styles.html' %}
  
  <!-- Include Backups Page Styles -->
  <link rel="stylesheet" href="/static/css/backups.css">
</head>
<body>
  <!-- Include Universal Sidebar -->
  {% include 'sidebar.html' %}

  <div class="main-content">
    <div class="header-section">
      <div class="header-info">
        <h1>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Database Backups
        </h1>
        <div class="subtitle">
          Automatic timestamped backups of the tracks database
        </div>
      </div>
      <div class="header-actions">
        <button id="createBackupBtn" class="btn btn-success">
          ğŸ’¾ Create New Backup
        </button>
        <button id="restartBtn" class="btn btn-warning">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path d="M8 16H3v5"/>
          </svg>
          Restart
        </button>
      </div>
    </div>

    <div class="backup-info">
      <h3>ğŸ’¡ About Database Backups</h3>
      <p>
        Backups are stored in <code>Backups/DB/</code> with UTC timestamps. Each backup preserves:
      </p>
      <ul>
        <li>All track metadata and play statistics</li>
        <li>Playlist information and relationships</li>
        <li>Complete play history</li>
        <li>Database structure and indexes</li>
      </ul>
      <div class="backup-actions">
        <button id="refreshBtn" class="btn">ğŸ”„ Refresh List</button>
        <span>
          Backups are created using SQLite's built-in backup API for consistency
        </span>
      </div>
    </div>

    <!-- Auto Backup Configuration -->
    <div class="backup-info backup-info-spaced">
      <h3>ğŸ¤– Automatic Backups</h3>
              <div id="autoBackupStatus" class="status-container">
        <div class="loading-message">Loading auto backup status...</div>
      </div>
      <div class="backup-actions">
        <button id="configAutoBackupBtn" class="btn">âš™ï¸ Configure</button>
        <button id="forceBackupBtn" class="btn btn-warning">ğŸš€ Force Backup Now</button>
        <button id="viewJobsBtn" class="btn btn-purple">ğŸ“‹ View Jobs</button>
        <button id="scheduleBackupBtn" class="btn btn-purple">ğŸ—“ï¸ Schedule Backup</button>
      </div>
    </div>

    <!-- Auto Backup Configuration Modal -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <h3>Auto Backup Configuration</h3>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="enabledCheckbox"> Enable automatic backups
          </label>
        </div>
        
        <div class="form-group">
          <label>Schedule time (UTC):</label>
          <input type="time" id="scheduleTimeInput">
        </div>
        
        <!-- Retention field removed - automatic cleanup is disabled by default -->
        
        <div class="form-group">
          <label>Check interval (minutes):</label>
          <input type="number" id="checkIntervalInput" min="1" max="1440" class="form-input-small">
        </div>
        
        <div class="btn-group">
          <button id="saveConfigBtn" class="btn btn-success">ğŸ’¾ Save</button>
          <button id="cancelConfigBtn" class="btn">âŒ Cancel</button>
        </div>
      </div>
    </div>

    <!-- Jobs Modal -->
    <div id="jobsModal" class="modal">
      <div class="modal-content modal-content-large">
        <h3>Recent Backup Jobs</h3>
        <div id="jobsList" class="jobs-list">
          Loading jobs...
        </div>
        <div class="modal-actions">
          <button id="closeJobsBtn" class="btn">âŒ Close</button>
        </div>
      </div>
    </div>

    <!-- Scheduler Modal for Backup -->
    <div id="scheduleModal" class="modal">
      <div class="modal-content">
        <h3>Schedule Database Backup</h3>
        <div class="form-group">
          <label>Enabled:</label>
          <select id="bk_enabled">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div class="form-group">
          <label>Kind:</label>
          <select id="bk_kind" onchange="bkOnKindChange()">
            <option value="daily" selected>daily</option>
            <option value="weekly">weekly</option>
            <option value="interval">interval</option>
          </select>
        </div>
        <div class="form-group" id="bk_row_time">
          <label>Time (UTC):</label>
          <input type="time" id="bk_time" value="02:00" pattern="^([01]\\d|2[0-3]):[0-5]\\d$" title="Use 24-hour format HH:MM (00:00â€“23:59)">
        </div>
        <div class="form-group" id="bk_row_days" style="display:none">
          <label>Days:</label>
          <div class="days">
            <label><input type="checkbox" value="mon">Mon</label>
            <label><input type="checkbox" value="tue">Tue</label>
            <label><input type="checkbox" value="wed">Wed</label>
            <label><input type="checkbox" value="thu">Thu</label>
            <label><input type="checkbox" value="fri">Fri</label>
            <label><input type="checkbox" value="sat">Sat</label>
            <label><input type="checkbox" value="sun">Sun</label>
          </div>
        </div>
        <div class="form-group" id="bk_row_interval" style="display:none">
          <label>Interval (minutes):</label>
          <input type="number" id="bk_interval" min="5" step="5" value="60">
        </div>
        <div class="form-group">
          <label>Retention days:</label>
          <input type="number" id="bk_retention" min="1" step="1" value="30">
        </div>
        <div class="btn-group">
          <button id="bk_save_btn" class="btn btn-success">ğŸ’¾ Save</button>
          <button id="bk_run_now_btn" class="btn">ğŸš€ Run now</button>
          <button id="bk_delete_btn" class="btn">ğŸ—‘ï¸ Delete</button>
          <button id="bk_close_btn" class="btn">âŒ Close</button>
        </div>
      </div>
    </div>

    <div id="backupsList">
      <!-- Backups will be loaded here -->
      <div class="loading-container">
        <div class="loading-icon">â³</div>
        Loading backups...
      </div>
    </div>

    <script>
      let backups = [];

      async function loadBackups() {
        const listDiv = document.getElementById('backupsList');
        
        try {
          listDiv.innerHTML = '<div class="loading-container"><div class="loading-icon">â³</div>Loading backups...</div>';
          
          const res = await fetch('/api/backups');
          const data = await res.json();
          
          if (data.status === 'ok') {
            backups = data.backups || [];
            renderBackups();
          } else {
            listDiv.innerHTML = `<div class="no-backups error-message">âŒ Error loading backups: ${data.message || 'Unknown error'}</div>`;
          }
        } catch (err) {
          listDiv.innerHTML = `<div class="no-backups error-message">âŒ Failed to load backups: ${err.message}</div>`;
        }
      }

      function renderBackups() {
        const listDiv = document.getElementById('backupsList');
        
        if (backups.length === 0) {
          listDiv.innerHTML = `
            <div class="no-backups">
              <div class="no-backups-icon">ğŸ“¦</div>
              <h3 class="no-backups-title">No backups found</h3>
              <p class="no-backups-text">Create your first backup using the button above</p>
            </div>
          `;
          return;
        }

        let html = `
          <table id="backupsTable">
            <thead>
              <tr>
                <th onclick="sortBackups('timestamp_display')">Date Created <span class="arrow">â–¼</span></th>
                <th onclick="sortBackups('size_display')">File Size <span class="arrow"></span></th>
                <th onclick="sortBackups('folder_name')">Backup ID <span class="arrow"></span></th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        backups.forEach(backup => {
          html += `
            <tr>
              <td style="font-weight:500;">${backup.timestamp_display}</td>
              <td>${backup.size_display}</td>
              <td style="font-family:monospace;font-size:12px;color:#888;">${backup.folder_name}</td>
              <td>
                <button onclick="downloadBackup('${backup.backup_path}')" class="btn btn-small">ğŸ“¥ Download</button>
              </td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
          <div class="stats-display">
            Total backups: ${backups.length} | 
            Latest: ${backups[0]?.timestamp_display || 'None'} |
            Storage used: ${calculateTotalSize()}
          </div>
        `;

        listDiv.innerHTML = html;
      }

      function sortBackups(field) {
        // Simple sort toggle
        const isCurrentlySorted = backups.length > 1 && 
          (field === 'timestamp_display' ? backups[0].timestamp > backups[1].timestamp : 
           field === 'size_display' ? backups[0].size_bytes > backups[1].size_bytes :
           backups[0][field] > backups[1][field]);
        
        backups.sort((a, b) => {
          let aVal = field === 'size_display' ? a.size_bytes : a[field];
          let bVal = field === 'size_display' ? b.size_bytes : b[field];
          
          if (isCurrentlySorted) {
            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
          } else {
            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
          }
        });
        
        renderBackups();
      }

      function calculateTotalSize() {
        const totalBytes = backups.reduce((sum, backup) => sum + backup.size_bytes, 0);
        if (totalBytes < 1024 * 1024) {
          return `${(totalBytes / 1024).toFixed(1)} KB`;
        } else if (totalBytes < 1024 * 1024 * 1024) {
          return `${(totalBytes / (1024 * 1024)).toFixed(1)} MB`;
        } else {
          return `${(totalBytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
        }
      }

      function downloadBackup(backupPath) {
        // For now, just show the path (could implement download later)
        alert(`Backup location:\n${backupPath}\n\nYou can copy this file manually from the server.`);
      }

      // Create new backup
      document.getElementById('createBackupBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('createBackupBtn');
        btn.disabled = true;
        btn.textContent = 'ğŸ’¾ Creating...';
        
        try {
          const res = await fetch('/api/backup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
          });
          const data = await res.json();
          
          if (data.status === 'ok') {
            const sizeStr = data.size_bytes ? ` (${(data.size_bytes / (1024*1024)).toFixed(1)} MB)` : '';
            alert(`Database backup created successfully!${sizeStr}\nTimestamp: ${data.timestamp}`);
            // Reload the list
            await loadBackups();
          } else {
            alert('Backup error: ' + (data.message || 'unknown'));
          }
        } catch (err) {
          alert('Request failed: ' + err);
        } finally {
          btn.disabled = false;
          btn.textContent = 'ğŸ’¾ Create New Backup';
        }
      });

      // Refresh list
      document.getElementById('refreshBtn')?.addEventListener('click', () => {
        loadBackups();
      });

      // Load backups on page load
      loadBackups();
      loadAutoBackupStatus();

      // Auto backup functionality
      let autoBackupConfig = {};

      async function loadAutoBackupStatus() {
        const statusDiv = document.getElementById('autoBackupStatus');
        
        try {
          const res = await fetch('/api/backup_status');
          const data = await res.json();
          
          if (data.status === 'ok') {
            const status = data.auto_backup_status;
            autoBackupConfig = status;
            
            const enabledText = status.enabled ? 'âœ… Enabled' : 'âŒ Disabled';
            const runningText = status.running ? 'ğŸŸ¢ Running' : 'ğŸ”´ Stopped';
            
            statusDiv.innerHTML = `
              <div class="status-grid">
                <div><strong>Status:</strong> ${enabledText}</div>
                <div><strong>Service:</strong> ${runningText}</div>
                <div><strong>Schedule:</strong> Daily at ${status.schedule_time} UTC</div>
                <div><strong>Auto-cleanup:</strong> âŒ Disabled</div>
                <div><strong>Next backup:</strong> ${status.next_scheduled_backup}</div>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `<div class="error-message">Error loading status: ${data.message}</div>`;
          }
        } catch (err) {
          statusDiv.innerHTML = `<div class="error-message">Failed to load status: ${err.message}</div>`;
        }
      }

      // Configuration modal
      document.getElementById('configAutoBackupBtn')?.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/backup_config');
          const data = await res.json();
          
          if (data.status === 'ok') {
            const config = data.config;
            
            document.getElementById('enabledCheckbox').checked = config.enabled;
            document.getElementById('scheduleTimeInput').value = config.schedule_time;
            // retentionDaysInput removed - automatic cleanup disabled
            document.getElementById('checkIntervalInput').value = config.check_interval;
            
            document.getElementById('configModal').style.display = 'block';
          } else {
            alert('Error loading configuration: ' + data.message);
          }
        } catch (err) {
          alert('Failed to load configuration: ' + err.message);
        }
      });

      // Save configuration
      document.getElementById('saveConfigBtn')?.addEventListener('click', async () => {
        const config = {
          enabled: document.getElementById('enabledCheckbox').checked,
          schedule_time: document.getElementById('scheduleTimeInput').value,
          retention_days: 30, // Fixed value - automatic cleanup disabled
          check_interval: parseInt(document.getElementById('checkIntervalInput').value)
        };
        
        try {
          const res = await fetch('/api/backup_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
          });
          const data = await res.json();
          
          if (data.status === 'ok') {
            alert('Configuration saved successfully!');
            document.getElementById('configModal').style.display = 'none';
            loadAutoBackupStatus();
          } else {
            alert('Error saving configuration: ' + data.message);
          }
        } catch (err) {
          alert('Failed to save configuration: ' + err.message);
        }
      });

      // Cancel configuration
      document.getElementById('cancelConfigBtn')?.addEventListener('click', () => {
        document.getElementById('configModal').style.display = 'none';
      });

      // Force backup
      document.getElementById('forceBackupBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('forceBackupBtn');
        btn.disabled = true;
        btn.textContent = 'ğŸš€ Creating...';
        
        try {
          const res = await fetch('/api/backup_force', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
          });
          const data = await res.json();
          
          if (data.status === 'ok') {
            alert(`Backup job scheduled successfully!\nJob ID: ${data.job_id}`);
            loadAutoBackupStatus();
          } else {
            alert('Error scheduling backup: ' + data.message);
          }
        } catch (err) {
          alert('Failed to schedule backup: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'ğŸš€ Force Backup Now';
        }
      });

      // View jobs
      document.getElementById('viewJobsBtn')?.addEventListener('click', async () => {
        const jobsList = document.getElementById('jobsList');
        jobsList.innerHTML = 'Loading jobs...';
        
        try {
          const res = await fetch('/api/backup_jobs');
          const data = await res.json();
          
          if (data.status === 'ok') {
            const jobs = data.jobs;
            
            if (jobs.length === 0) {
              jobsList.innerHTML = '<div class="no-jobs-message">No backup jobs found</div>';
            } else {
              let html = '<table class="jobs-table">';
              html += '<tr><th>ID</th><th>Status</th><th>Created</th><th>Duration</th><th>Source</th></tr>';
              
              jobs.forEach(job => {
                const statusClass = job.status === 'completed' ? 'job-status-completed' : 
                                   job.status === 'failed' ? 'job-status-failed' : 
                                   job.status === 'running' ? 'job-status-running' : 'job-status-default';
                
                const duration = job.duration_seconds ? 
                  `${Math.round(job.duration_seconds)}s` : 
                  (job.status === 'running' ? 'Running...' : '-');
                
                const createdDate = job.created_at ? 
                  new Date(job.created_at + 'Z').toLocaleString(undefined, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) : '-';
                
                html += `<tr>
                  <td>${job.id}</td>
                  <td class="${statusClass}">${job.status}</td>
                  <td>${createdDate}</td>
                  <td>${duration}</td>
                  <td>${job.source}</td>
                </tr>`;
              });
              
              html += '</table>';
              jobsList.innerHTML = html;
            }
            
            document.getElementById('jobsModal').style.display = 'block';
          } else {
            alert('Error loading jobs: ' + data.message);
          }
        } catch (err) {
          alert('Failed to load jobs: ' + err.message);
        }
      });

      // Close jobs modal
      document.getElementById('closeJobsBtn')?.addEventListener('click', () => {
        document.getElementById('jobsModal').style.display = 'none';
      });

      // Close modals on background click
      document.getElementById('configModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'configModal') {
          document.getElementById('configModal').style.display = 'none';
        }
      });

      document.getElementById('jobsModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'jobsModal') {
          document.getElementById('jobsModal').style.display = 'none';
        }
      });

      // ================= Scheduler Integration (Database Backup) =================
      let bkEditingId = null; // schedule id

      document.getElementById('scheduleBackupBtn')?.addEventListener('click', async () => {
        await bkOpenEditor();
      });

      document.getElementById('bk_close_btn')?.addEventListener('click', () => {
        document.getElementById('scheduleModal').style.display = 'none';
      });

      document.getElementById('scheduleModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'scheduleModal') {
          document.getElementById('scheduleModal').style.display = 'none';
        }
      });

      document.getElementById('bk_save_btn')?.addEventListener('click', async () => {
        await bkSave();
      });

      document.getElementById('bk_run_now_btn')?.addEventListener('click', async () => {
        if (!bkEditingId) { alert('Create and save the schedule first'); return; }
        try {
          const res = await fetch(`/api/schedules/${bkEditingId}/run_now`, { method: 'POST' });
          const data = await res.json();
          if (data.status === 'ok') { alert('Backup triggered'); }
          else { alert(data.error || 'Failed to trigger'); }
        } catch (e) { alert(e.message || e); }
      });

      document.getElementById('bk_delete_btn')?.addEventListener('click', async () => {
        if (!bkEditingId) { alert('No schedule to delete'); return; }
        if (!confirm('Delete backup schedule?')) return;
        try {
          const res = await fetch(`/api/schedules/${bkEditingId}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.status === 'ok') { bkEditingId = null; document.getElementById('scheduleModal').style.display = 'none'; }
          else { alert(data.error || 'Delete failed'); }
        } catch (e) { alert(e.message || e); }
      });

      function bkOnKindChange() {
        const kind = document.getElementById('bk_kind').value;
        document.getElementById('bk_row_time').style.display = (kind === 'daily' || kind === 'weekly') ? '' : 'none';
        document.getElementById('bk_row_days').style.display = (kind === 'weekly') ? '' : 'none';
        document.getElementById('bk_row_interval').style.display = (kind === 'interval') ? '' : 'none';
      }
      window.bkOnKindChange = bkOnKindChange;

      async function bkOpenEditor() {
        try {
          // Load existing backup schedules (we manage the first one)
          const res = await fetch('/api/schedules?task_type=DATABASE_BACKUP');
          const data = await res.json();
          let item = null;
          if (data.status === 'ok' && Array.isArray(data.schedules) && data.schedules.length > 0) {
            item = data.schedules[0];
          }
          bkEditingId = item?.id || null;
          document.getElementById('bk_enabled').value = String(item?.enabled ?? true);
          document.getElementById('bk_kind').value = item?.schedule_kind || 'daily';
          document.getElementById('bk_time').value = item?.schedule_time || '02:00';
          document.getElementById('bk_interval').value = item?.interval_minutes || 60;
          // days
          const dayInputs = document.querySelectorAll('#bk_row_days input[type="checkbox"]');
          const days = item?.schedule_days || [];
          dayInputs.forEach(cb => cb.checked = days.includes(cb.value));
          // params
          const retention = item?.params?.retention_days ?? 30;
          document.getElementById('bk_retention').value = retention;
          bkOnKindChange();
          document.getElementById('scheduleModal').style.display = 'block';
        } catch (e) {
          alert('Failed to load schedule: ' + (e.message || e));
        }
      }

      async function bkSave() {
        const payload = {
          name: 'Database Backup',
          task_type: 'DATABASE_BACKUP',
          schedule_kind: document.getElementById('bk_kind').value,
          enabled: document.getElementById('bk_enabled').value === 'true',
          params: {
            backup_type: 'full',
            retention_days: parseInt(document.getElementById('bk_retention').value || '30', 10),
            cleanup_old: false
          }
        };
        if (payload.schedule_kind === 'daily' || payload.schedule_kind === 'weekly') {
          payload.schedule_time = document.getElementById('bk_time').value;
        }
        if (payload.schedule_kind === 'weekly') {
          const days = Array.from(document.querySelectorAll('#bk_row_days input[type="checkbox"]:checked')).map(cb => cb.value);
          payload.schedule_days = days;
        }
        if (payload.schedule_kind === 'interval') {
          payload.interval_minutes = parseInt(document.getElementById('bk_interval').value || '60', 10);
        }

        const method = bkEditingId ? 'PATCH' : 'POST';
        const url = bkEditingId ? `/api/schedules/${bkEditingId}` : '/api/schedules';
        try {
          const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.status === 'ok') {
            if (!bkEditingId) bkEditingId = data.id;
            alert('Backup schedule saved');
            document.getElementById('scheduleModal').style.display = 'none';
          } else {
            alert(data.error || 'Save failed');
          }
        } catch (e) {
          alert(e.message || e);
        }
      }

      // Restart Server
      const restartBtn = document.getElementById('restartBtn');
      restartBtn?.addEventListener('click', async () => {
          if(!confirm('Are you sure you want to restart the server? This may interrupt current operations.')) return;
          restartBtn.disabled = true;
          restartBtn.innerHTML = 'â³ Restarting...';
          try{
              await fetch('/api/restart', {
                  method:'POST',
                  headers:{'Content-Type':'application/json'}
              });
              setTimeout(() => location.reload(), 4000);
          }catch(err){
              setTimeout(() => location.reload(), 4000);
          }
      });
    </script>
  </div>
</body>
</html> 