<!-- Database backups list page -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Database Backups</title>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:20px;}
    h1{margin-bottom:20px;}
    a{color:#61dafb; text-decoration:none;}
    a:hover{text-decoration:underline;}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:15px;}
    th,td{padding:8px 12px;text-align:left;}
    th{border-bottom:2px solid #444;background:#1a1a1a;cursor:pointer;}
    tbody tr{border-bottom:1px solid #333;}
    tbody tr:hover{background:#1a1a1a;}
    .arrow{margin-left:4px;font-size:10px;}
    .no-backups{text-align:center;color:#888;padding:40px;}
    .backup-info{background:#1a1a1a;padding:15px;border-radius:6px;margin-bottom:20px;}
    .backup-info h3{margin:0 0 8px 0;color:#4caf50;}
    .backup-actions{margin-top:15px;}
    .backup-actions button{padding:6px 12px;font-size:14px;cursor:pointer;margin-right:8px;}
    .create-backup{background:#4caf50;color:#fff;border:1px solid #388e3c;}
    .create-backup:disabled{background:#666;border-color:#555;}
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;">Database Backups</h1>
      <div style="font-size:12px;color:#888;margin-top:4px;">
        Automatic timestamped backups of the tracks database
      </div>
    </div>
    <div style="display:flex;gap:8px;">
      <a href="/" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">‚Üê Back to Home</a>
      <button id="createBackupBtn" class="create-backup" style="padding:6px 12px;font-size:14px;cursor:pointer;border-radius:4px;">üíæ Create New Backup</button>
    </div>
  </div>

  <div class="backup-info">
    <h3>üí° About Database Backups</h3>
    <p style="margin:4px 0;color:#ccc;font-size:14px;">
      Backups are stored in <code>Backups/DB/</code> with UTC timestamps. Each backup preserves:
    </p>
    <ul style="margin:8px 0;color:#aaa;font-size:13px;">
      <li>All track metadata and play statistics</li>
      <li>Playlist information and relationships</li>
      <li>Complete play history</li>
      <li>Database structure and indexes</li>
    </ul>
    <div class="backup-actions">
      <button id="refreshBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">üîÑ Refresh List</button>
      <span style="color:#888;font-size:12px;margin-left:12px;">
        Backups are created using SQLite's built-in backup API for consistency
      </span>
    </div>
  </div>

  <!-- Auto Backup Configuration -->
  <div class="backup-info" style="margin-top:20px;">
    <h3>ü§ñ Automatic Backups</h3>
    <div id="autoBackupStatus" style="margin:8px 0;">
      <div style="color:#888;">Loading auto backup status...</div>
    </div>
    <div class="backup-actions">
      <button id="configAutoBackupBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">‚öôÔ∏è Configure</button>
      <button id="forceBackupBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;background:#ff9800;color:#fff;border:1px solid #f57c00;">üöÄ Force Backup Now</button>
      <button id="viewJobsBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;background:#9c27b0;color:#fff;border:1px solid #7b1fa2;">üìã View Jobs</button>
    </div>
  </div>

  <!-- Auto Backup Configuration Modal -->
  <div id="configModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:20px;border-radius:8px;min-width:400px;max-width:90%;">
      <h3 style="margin:0 0 15px 0;color:#4caf50;">Auto Backup Configuration</h3>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;color:#ccc;">
          <input type="checkbox" id="enabledCheckbox"> Enable automatic backups
        </label>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;color:#ccc;">Schedule time (UTC):</label>
        <input type="time" id="scheduleTimeInput" style="padding:5px;background:#333;border:1px solid #555;color:#fff;border-radius:3px;">
      </div>
      
      <!-- Retention field removed - automatic cleanup is disabled by default -->
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;color:#ccc;">Check interval (minutes):</label>
        <input type="number" id="checkIntervalInput" min="1" max="1440" style="padding:5px;background:#333;border:1px solid #555;color:#fff;border-radius:3px;width:80px;">
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button id="saveConfigBtn" style="padding:8px 15px;background:#4caf50;color:#fff;border:1px solid #388e3c;border-radius:4px;cursor:pointer;">üíæ Save</button>
        <button id="cancelConfigBtn" style="padding:8px 15px;background:#666;color:#fff;border:1px solid #555;border-radius:4px;cursor:pointer;">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <!-- Jobs Modal -->
  <div id="jobsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:20px;border-radius:8px;min-width:600px;max-width:90%;max-height:80%;">
      <h3 style="margin:0 0 15px 0;color:#4caf50;">Recent Backup Jobs</h3>
      <div id="jobsList" style="max-height:400px;overflow-y:auto;">
        Loading jobs...
      </div>
      <div style="margin-top:15px;">
        <button id="closeJobsBtn" style="padding:8px 15px;background:#666;color:#fff;border:1px solid #555;border-radius:4px;cursor:pointer;">‚ùå Close</button>
      </div>
    </div>
  </div>

  <div id="backupsList">
    <!-- Backups will be loaded here -->
    <div style="text-align:center;color:#888;padding:40px;">
      <div style="font-size:18px;margin-bottom:8px;">‚è≥</div>
      Loading backups...
    </div>
  </div>

  <script>
    let backups = [];

    async function loadBackups() {
      const listDiv = document.getElementById('backupsList');
      
      try {
        listDiv.innerHTML = '<div style="text-align:center;color:#888;padding:40px;"><div style="font-size:18px;margin-bottom:8px;">‚è≥</div>Loading backups...</div>';
        
        const res = await fetch('/api/backups');
        const data = await res.json();
        
        if (data.status === 'ok') {
          backups = data.backups || [];
          renderBackups();
        } else {
          listDiv.innerHTML = `<div class="no-backups">‚ùå Error loading backups: ${data.message || 'Unknown error'}</div>`;
        }
      } catch (err) {
        listDiv.innerHTML = `<div class="no-backups">‚ùå Failed to load backups: ${err.message}</div>`;
      }
    }

    function renderBackups() {
      const listDiv = document.getElementById('backupsList');
      
      if (backups.length === 0) {
        listDiv.innerHTML = `
          <div class="no-backups">
            <div style="font-size:48px;margin-bottom:16px;">üì¶</div>
            <h3 style="color:#888;margin:0 0 8px 0;">No backups found</h3>
            <p style="color:#666;margin:0;">Create your first backup using the button above</p>
          </div>
        `;
        return;
      }

      let html = `
        <table id="backupsTable">
          <thead>
            <tr>
              <th onclick="sortBackups('timestamp_display')">Date Created <span class="arrow">‚ñº</span></th>
              <th onclick="sortBackups('size_display')">File Size <span class="arrow"></span></th>
              <th onclick="sortBackups('folder_name')">Backup ID <span class="arrow"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      backups.forEach(backup => {
        html += `
          <tr>
            <td style="font-weight:500;">${backup.timestamp_display}</td>
            <td>${backup.size_display}</td>
            <td style="font-family:monospace;font-size:12px;color:#888;">${backup.folder_name}</td>
            <td>
              <button onclick="downloadBackup('${backup.backup_path}')" style="padding:4px 8px;font-size:12px;cursor:pointer;background:#2196f3;color:#fff;border:1px solid #1976d2;border-radius:3px;">üì• Download</button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top:15px;font-size:12px;color:#666;">
          Total backups: ${backups.length} | 
          Latest: ${backups[0]?.timestamp_display || 'None'} |
          Storage used: ${calculateTotalSize()}
        </div>
      `;

      listDiv.innerHTML = html;
    }

    function sortBackups(field) {
      // Simple sort toggle
      const isCurrentlySorted = backups.length > 1 && 
        (field === 'timestamp_display' ? backups[0].timestamp > backups[1].timestamp : 
         field === 'size_display' ? backups[0].size_bytes > backups[1].size_bytes :
         backups[0][field] > backups[1][field]);
      
      backups.sort((a, b) => {
        let aVal = field === 'size_display' ? a.size_bytes : a[field];
        let bVal = field === 'size_display' ? b.size_bytes : b[field];
        
        if (isCurrentlySorted) {
          return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
          return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
      });
      
      renderBackups();
    }

    function calculateTotalSize() {
      const totalBytes = backups.reduce((sum, backup) => sum + backup.size_bytes, 0);
      if (totalBytes < 1024 * 1024) {
        return `${(totalBytes / 1024).toFixed(1)} KB`;
      } else if (totalBytes < 1024 * 1024 * 1024) {
        return `${(totalBytes / (1024 * 1024)).toFixed(1)} MB`;
      } else {
        return `${(totalBytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
      }
    }

    function downloadBackup(backupPath) {
      // For now, just show the path (could implement download later)
      alert(`Backup location:\n${backupPath}\n\nYou can copy this file manually from the server.`);
    }

    // Create new backup
    document.getElementById('createBackupBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('createBackupBtn');
      btn.disabled = true;
      btn.textContent = 'üíæ Creating...';
      
      try {
        const res = await fetch('/api/backup', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        
        if (data.status === 'ok') {
          const sizeStr = data.size_bytes ? ` (${(data.size_bytes / (1024*1024)).toFixed(1)} MB)` : '';
          alert(`Database backup created successfully!${sizeStr}\nTimestamp: ${data.timestamp}`);
          // Reload the list
          await loadBackups();
        } else {
          alert('Backup error: ' + (data.message || 'unknown'));
        }
      } catch (err) {
        alert('Request failed: ' + err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ Create New Backup';
      }
    });

    // Refresh list
    document.getElementById('refreshBtn')?.addEventListener('click', () => {
      loadBackups();
    });

    // Load backups on page load
    loadBackups();
    loadAutoBackupStatus();

    // Auto backup functionality
    let autoBackupConfig = {};

    async function loadAutoBackupStatus() {
      const statusDiv = document.getElementById('autoBackupStatus');
      
      try {
        const res = await fetch('/api/backup_status');
        const data = await res.json();
        
        if (data.status === 'ok') {
          const status = data.auto_backup_status;
          autoBackupConfig = status;
          
          const enabledText = status.enabled ? '‚úÖ Enabled' : '‚ùå Disabled';
          const runningText = status.running ? 'üü¢ Running' : 'üî¥ Stopped';
          
          statusDiv.innerHTML = `
            <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:13px;">
              <div><strong>Status:</strong> ${enabledText}</div>
              <div><strong>Service:</strong> ${runningText}</div>
              <div><strong>Schedule:</strong> Daily at ${status.schedule_time} UTC</div>
              <div><strong>Auto-cleanup:</strong> ‚ùå Disabled</div>
              <div><strong>Next backup:</strong> ${status.next_scheduled_backup}</div>
            </div>
          `;
        } else {
          statusDiv.innerHTML = `<div style="color:#f44336;">Error loading status: ${data.message}</div>`;
        }
      } catch (err) {
        statusDiv.innerHTML = `<div style="color:#f44336;">Failed to load status: ${err.message}</div>`;
      }
    }

    // Configuration modal
    document.getElementById('configAutoBackupBtn')?.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/backup_config');
        const data = await res.json();
        
        if (data.status === 'ok') {
          const config = data.config;
          
          document.getElementById('enabledCheckbox').checked = config.enabled;
          document.getElementById('scheduleTimeInput').value = config.schedule_time;
          // retentionDaysInput removed - automatic cleanup disabled
          document.getElementById('checkIntervalInput').value = config.check_interval;
          
          document.getElementById('configModal').style.display = 'block';
        } else {
          alert('Error loading configuration: ' + data.message);
        }
      } catch (err) {
        alert('Failed to load configuration: ' + err.message);
      }
    });

    // Save configuration
    document.getElementById('saveConfigBtn')?.addEventListener('click', async () => {
      const config = {
        enabled: document.getElementById('enabledCheckbox').checked,
        schedule_time: document.getElementById('scheduleTimeInput').value,
        retention_days: 30, // Fixed value - automatic cleanup disabled
        check_interval: parseInt(document.getElementById('checkIntervalInput').value)
      };
      
      try {
        const res = await fetch('/api/backup_config', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(config)
        });
        const data = await res.json();
        
        if (data.status === 'ok') {
          alert('Configuration saved successfully!');
          document.getElementById('configModal').style.display = 'none';
          loadAutoBackupStatus();
        } else {
          alert('Error saving configuration: ' + data.message);
        }
      } catch (err) {
        alert('Failed to save configuration: ' + err.message);
      }
    });

    // Cancel configuration
    document.getElementById('cancelConfigBtn')?.addEventListener('click', () => {
      document.getElementById('configModal').style.display = 'none';
    });

    // Force backup
    document.getElementById('forceBackupBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('forceBackupBtn');
      btn.disabled = true;
      btn.textContent = 'üöÄ Creating...';
      
      try {
        const res = await fetch('/api/backup_force', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        
        if (data.status === 'ok') {
          alert(`Backup job scheduled successfully!\nJob ID: ${data.job_id}`);
          loadAutoBackupStatus();
        } else {
          alert('Error scheduling backup: ' + data.message);
        }
      } catch (err) {
        alert('Failed to schedule backup: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üöÄ Force Backup Now';
      }
    });

    // View jobs
    document.getElementById('viewJobsBtn')?.addEventListener('click', async () => {
      const jobsList = document.getElementById('jobsList');
      jobsList.innerHTML = 'Loading jobs...';
      
      try {
        const res = await fetch('/api/backup_jobs');
        const data = await res.json();
        
        if (data.status === 'ok') {
          const jobs = data.jobs;
          
          if (jobs.length === 0) {
            jobsList.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">No backup jobs found</div>';
          } else {
            let html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#333;"><th style="padding:6px;text-align:left;">ID</th><th style="padding:6px;text-align:left;">Status</th><th style="padding:6px;text-align:left;">Created</th><th style="padding:6px;text-align:left;">Duration</th><th style="padding:6px;text-align:left;">Source</th></tr>';
            
            jobs.forEach(job => {
              const statusColor = job.status === 'completed' ? '#4caf50' : 
                                 job.status === 'failed' ? '#f44336' : 
                                 job.status === 'running' ? '#ff9800' : '#666';
              
              const duration = job.duration_seconds ? 
                `${Math.round(job.duration_seconds)}s` : 
                (job.status === 'running' ? 'Running...' : '-');
              
              const createdDate = job.created_at ? 
                new Date(job.created_at).toLocaleString() : '-';
              
              html += `<tr style="border-bottom:1px solid #333;">
                <td style="padding:6px;">${job.id}</td>
                <td style="padding:6px;color:${statusColor};">${job.status}</td>
                <td style="padding:6px;">${createdDate}</td>
                <td style="padding:6px;">${duration}</td>
                <td style="padding:6px;">${job.source}</td>
              </tr>`;
            });
            
            html += '</table>';
            jobsList.innerHTML = html;
          }
          
          document.getElementById('jobsModal').style.display = 'block';
        } else {
          alert('Error loading jobs: ' + data.message);
        }
      } catch (err) {
        alert('Failed to load jobs: ' + err.message);
      }
    });

    // Close jobs modal
    document.getElementById('closeJobsBtn')?.addEventListener('click', () => {
      document.getElementById('jobsModal').style.display = 'none';
    });

    // Close modals on background click
    document.getElementById('configModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'configModal') {
        document.getElementById('configModal').style.display = 'none';
      }
    });

    document.getElementById('jobsModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'jobsModal') {
        document.getElementById('jobsModal').style.display = 'none';
      }
    });
  </script>
</body>
</html> 