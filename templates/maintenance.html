<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Maintenance - YouTube Player</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🎵</text></svg>">
    
    <!-- Include Sidebar Styles -->
    {% include 'sidebar_styles.html' %}
    
    <!-- Maintenance page compact styles -->
    <link rel="stylesheet" href="/static/css/maintenance.css">
</head>
<body>
    <!-- Include Universal Sidebar -->
    {% include 'sidebar.html' %}

    <div class="main-content">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>
                        <span>🔧</span>
                        System Maintenance
                    </h1>
                    <p>Comprehensive system administration and maintenance tools</p>
                </div>
                <div class="header-actions">
                    <button id="restartBtn" class="btn btn-warning">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M8 16H3v5"/>
                        </svg>
                        Restart
                    </button>
                </div>
            </div>

            <!-- System Statistics -->
            <div class="stats-section" role="region" aria-label="System Statistics">
                <h3>System Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-tracks">-</div>
                        <div class="stat-label">Total Tracks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="missing-metadata">-</div>
                        <div class="stat-label">Missing Metadata</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pending-jobs">-</div>
                        <div class="stat-label">Pending Jobs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="db-size">-</div>
                        <div class="stat-label">Database Size</div>
                    </div>
                </div>
            </div>

            <!-- Maintenance Operations -->
            <div class="maintenance-grid">
                <!-- Database Operations -->
                <div class="card collapsible" id="card-database">
                    <div class="card-header database" role="button" tabindex="0" aria-expanded="true" aria-controls="card-body-database">
                        <div class="header-left"><span>🗄️</span> Database Operations</div>
                        <span class="chevron">▾</span>
                    </div>
                    <div class="card-body" id="card-body-database">
                        <div class="card-description">
                            Manage database backups, optimization, and maintenance operations.
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="createBackup()">
                                <span>💾</span>
                                Create Database Backup
                            </button>
                            <button class="btn btn-secondary" onclick="runMaintenance()">
                                <span>🔧</span>
                                Run Database Maintenance
                            </button>
                            <button class="btn btn-secondary" onclick="rescanLibrary()">
                                <span>🔍</span>
                                Rescan Library
                            </button>
                             <button class="btn" onclick="enqueueLibraryRescan()">
                                 <span>🗂️</span>
                                 Enqueue Library Rescan (Jobs)
                             </button>
                        </div>
                        <div class="status-display" id="database-status">
                            Ready to perform database operations
                        </div>
                    </div>
                </div>

                <!-- Metadata Operations -->
                <div class="card collapsible" id="card-metadata">
                    <div class="card-header metadata" role="button" tabindex="0" aria-expanded="true" aria-controls="card-body-metadata">
                        <div class="header-left"><span>📊</span> Metadata Operations</div>
                        <span class="chevron">▾</span>
                    </div>
                    <div class="card-body" id="card-body-metadata">
                        <div class="card-description">
                            Scan and extract missing metadata for tracks without publication dates and other YouTube information.
                        </div>
                        <div id="metadata-stats-inline" style="font-size:12px; line-height:1.2; margin-bottom: 6px; color: var(--text-secondary);">
                            <div><strong>Total Tracks</strong>: <span id="meta-total-tracks">-</span></div>
                            <div><strong>With Metadata</strong>: <span id="meta-with-metadata">-</span></div>
                            <div><strong>Without Metadata</strong>: <span id="meta-without-metadata">-</span></div>
                            <div><strong>Coverage</strong>: <span id="meta-coverage">-</span></div>
                            <div><strong>Recent Additions (7d)</strong>: <span id="meta-recent">-</span></div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="scanMissingMetadata()">
                                <span>🔍</span>
                                Scan Missing Metadata
                            </button>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <input id="qualitiesLimit" type="number" min="1" max="5000" step="1" placeholder="Limit (e.g., 100)" style="padding:6px 10px; width:140px;" />
                                <button class="btn" onclick="scanMissingYoutubeQualities()">
                                    <span>🎞️</span>
                                    Enqueue Missing YouTube Qualities
                                </button>
                            </div>
                        </div>
                        <div class="status-display" id="metadata-status">
                            Ready to scan missing metadata
                        </div>
                    </div>
                </div>

                <!-- System Operations -->
                <div class="card collapsible" id="card-system">
                    <div class="card-header system" role="button" tabindex="0" aria-expanded="true" aria-controls="card-body-system">
                        <div class="header-left"><span>⚙️</span> System Operations</div>
                        <span class="chevron">▾</span>
                    </div>
                    <div class="card-body" id="card-body-system">
                        <div class="card-description">
                            Monitor and control system performance, job queue, and system resources.
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="clearJobQueue()">
                                <span>🧹</span>
                                Clear Job Queue
                            </button>
                            <button class="btn btn-secondary" onclick="viewSystemLogs()">
                                <span>📋</span>
                                View System Logs
                            </button>
                            <button class="btn btn-secondary" onclick="refreshStats()">
                                <span>🔄</span>
                                Refresh Statistics
                            </button>
                            <button class="btn btn-secondary" onclick="loadCookiesHealth()">
                                <span>🍪</span>
                                Show Cookies Health
                            </button>
                        </div>
                        <div class="status-display" id="system-status">
                            System operational
                        </div>
                        <div id="cookies-health" style="margin-top: 12px; display: none;">
                            <div class="card-description">Cookies files success/failure counters (sorted by best first)</div>
                            <div id="cookies-health-content">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Cleanup Operations -->
                <div class="card collapsible" id="card-cleanup">
                    <div class="card-header cleanup" role="button" tabindex="0" aria-expanded="true" aria-controls="card-body-cleanup">
                        <div class="header-left"><span>🧹</span> Cleanup Operations</div>
                        <span class="chevron">▾</span>
                    </div>
                    <div class="card-body" id="card-body-cleanup">
                        <div class="card-description">
                            Clean up temporary files, old logs, and unused data to free up disk space.
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="cleanupOldLogs()">
                                <span>📜</span>
                                Cleanup Old Logs
                            </button>
                            <button class="btn btn-secondary" onclick="cleanupTempFiles()">
                                <span>🗑️</span>
                                Cleanup Temp Files
                            </button>
                            <button class="btn btn-secondary" onclick="clearTrash()">
                                <span>🗂️</span>
                                Clear Trash Folder
                            </button>
                        </div>
                        <div class="status-display" id="cleanup-status">
                            Ready to perform cleanup
                        </div>
                    </div>
                </div>

                <!-- Server Control -->
                <div class="card collapsible" id="card-server">
                    <div class="card-header server" role="button" tabindex="0" aria-expanded="true" aria-controls="card-body-server">
                        <div class="header-left"><span>🖥️</span> Server Control</div>
                        <span class="chevron">▾</span>
                    </div>
                    <div class="card-body" id="card-body-server">
                        <div class="card-description">
                            <strong>⚠️ Warning:</strong> These operations will affect server availability.
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="restartServer()">
                                <span>🔄</span>
                                Restart Server
                            </button>
                            <button class="btn btn-danger" onclick="stopServer()">
                                <span>⏹️</span>
                                Stop Server
                            </button>
                        </div>
                        <div class="status-display" id="server-status">
                            Server running (PID: {{ server_info.pid }})
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initCollapsibles();
            refreshStats();
        });

        // Utility functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-display ${type}`;
        }

        function showLoading(elementId) {
            showStatus(elementId, 'Processing...', 'processing');
        }

        // Statistics functions
        async function refreshStats() {
            try {
                // Get metadata statistics
                const metadataResponse = await fetch('/api/metadata_statistics');
                if (metadataResponse.ok) {
                    const metadataData = await metadataResponse.json();
                    const md = (metadataData && metadataData.statistics) ? metadataData.statistics : {};
                    // Top summary
                    document.getElementById('total-tracks').textContent = md.total_tracks ?? '-';
                    document.getElementById('missing-metadata').textContent = md.tracks_without_metadata ?? '-';
                    // Detailed metadata stats
                    const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                    setText('meta-total-tracks', md.total_tracks ?? '-');
                    setText('meta-with-metadata', md.tracks_with_metadata ?? '-');
                    setText('meta-without-metadata', md.tracks_without_metadata ?? '-');
                    setText('meta-coverage', (md.coverage_percent != null) ? `${md.coverage_percent}%` : '-');
                    setText('meta-recent', md.recent_additions ?? '-');
                }

                // Get job queue statistics
                const jobsResponse = await fetch('/api/jobs/queue/status');
                if (jobsResponse.ok) {
                    const jobsData = await jobsResponse.json();
                    document.getElementById('pending-jobs').textContent = jobsData.pending_count || '-';
                }

                // Get database size (approximate)
                document.getElementById('db-size').textContent = 'N/A';

            } catch (error) {
                console.error('Error refreshing statistics:', error);
            }
        }

        // Database operations
        async function createBackup() {
            showLoading('database-status');
            try {
                const response = await fetch('/api/backup', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('database-status', `Backup created successfully: ${data.backup_path || 'Success'}`, 'success');
                } else {
                    showStatus('database-status', `Backup failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('database-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function runMaintenance() {
            showLoading('database-status');
            try {
                const response = await fetch('/api/database/maintenance', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('database-status', 'Database maintenance completed successfully', 'success');
                } else {
                    showStatus('database-status', `Maintenance failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('database-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function rescanLibrary() {
            showLoading('database-status');
            try {
                const response = await fetch('/api/scan', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('database-status', 'Library rescan completed', 'success');
                } else {
                    showStatus('database-status', `Rescan failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('database-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function enqueueLibraryRescan() {
            showLoading('database-status');
            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_type: 'library_scan',
                        priority: 'LOW',
                        parameters: { refresh_duration: true, refresh_size: true }
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus('database-status', `Library rescan job enqueued (Job #${data.job_id})`, 'success');
                } else {
                    showStatus('database-status', `Enqueue failed: ${data.error || data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('database-status', `Network error: ${error.message}`, 'error');
            }
        }

        // Metadata operations
        async function scanMissingMetadata() {
            showLoading('metadata-status');
            try {
                const response = await fetch('/api/scan_missing_metadata', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dry_run: false })
                });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('metadata-status', `Metadata scan initiated: ${data.jobs_created || 0} jobs created`, 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    showStatus('metadata-status', `Scan failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('metadata-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function scanMissingMetadataLimited() {
            showLoading('metadata-status');
            try {
                const response = await fetch('/api/scan_missing_metadata', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dry_run: false, limit: 50 })
                });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('metadata-status', `Limited scan initiated: ${data.jobs_created || 0} jobs created`, 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    showStatus('metadata-status', `Scan failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('metadata-status', `Network error: ${error.message}`, 'error');
            }
        }

        function viewMetadataStats() {
            window.open('/api/metadata_statistics', '_blank');
        }

        async function scanMissingYoutubeQualities() {
            showLoading('metadata-status');
            try {
                const limitVal = document.getElementById('qualitiesLimit')?.value;
                const payload = { force_update: true };
                if (limitVal && String(limitVal).trim() !== '') {
                    const n = parseInt(limitVal, 10);
                    if (!isNaN(n) && n > 0) payload.limit = n;
                }
                const response = await fetch('/api/scan_missing_youtube_qualities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus('metadata-status', `YouTube Qualities scan started: ${data.jobs_created || 0} jobs created`, 'success');
                } else {
                    showStatus('metadata-status', `Qualities scan failed: ${data.error || data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('metadata-status', `Network error: ${error.message}`, 'error');
            }
        }

        // System operations
        async function clearJobQueue() {
            if (!confirm('Are you sure you want to clear all pending jobs?')) return;
            
            showLoading('system-status');
            try {
                const response = await fetch('/api/jobs/clear_queue', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: true })
                });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('system-status', `Job queue cleared: ${data.cleared_count} jobs removed`, 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    showStatus('system-status', `Clear failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('system-status', `Network error: ${error.message}`, 'error');
            }
        }

        // Cookies health UI (restored)
        async function loadCookiesHealth() {
            const box = document.getElementById('cookies-health');
            const content = document.getElementById('cookies-health-content');
            box.style.display = 'block';
            content.textContent = 'Loading...';
            try {
                const res = await fetch('/api/cookies/health');
                const data = await res.json();
                if (data.status !== 'ok') {
                    content.textContent = 'Error: ' + (data.error || 'Unknown');
                    return;
                }
                if (!data.files || data.files.length === 0) {
                    content.textContent = 'No cookies data available';
                    return;
                }
                const header = '<thead><tr><th>File</th><th>Successes</th><th>Failures</th><th>Last Success (ts)</th><th>Last Failure (ts)</th></tr></thead>';
                const rows = data.files.map(f => `<tr><td>${f.file}</td><td>${f.successes}</td><td>${f.failures}</td><td>${f.last_success_ts}</td><td>${f.last_failure_ts}</td></tr>`).join('');
                content.innerHTML = `<table class="table">${header}<tbody>${rows}</tbody></table>`;
            } catch (e) {
                content.textContent = 'Error loading cookies health: ' + e;
            }
        }

        function viewSystemLogs() {
            window.open('/logs', '_blank');
        }

        // Collapsible sections (non-breaking, uses localStorage)
        function initCollapsibles() {
            try {
                const cards = document.querySelectorAll('.card.collapsible');
                cards.forEach(card => {
                    const header = card.querySelector('.card-header');
                    const body = card.querySelector('.card-body');
                    if (!header || !body) return;

                    const storageKey = `maintenance.collapse.${card.id || header.textContent.trim()}`;
                    const saved = localStorage.getItem(storageKey);
                    const collapsed = saved === 'collapsed';
                    if (collapsed) {
                        card.classList.add('collapsed');
                        header.setAttribute('aria-expanded', 'false');
                    } else {
                        header.setAttribute('aria-expanded', 'true');
                    }

                    const toggle = () => {
                        const isCollapsed = card.classList.toggle('collapsed');
                        const expanded = !isCollapsed;
                        header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                        localStorage.setItem(storageKey, isCollapsed ? 'collapsed' : 'expanded');
                    };

                    header.addEventListener('click', toggle);
                    header.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggle();
                        }
                    });
                });
            } catch (e) {
                // fail-safe: do nothing
            }
        }

        // Cleanup operations
        async function cleanupOldLogs() {
            showLoading('cleanup-status');
            try {
                const response = await fetch('/api/cleanup/logs', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('cleanup-status', 'Old logs cleaned up successfully', 'success');
                } else {
                    showStatus('cleanup-status', `Cleanup failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('cleanup-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function cleanupTempFiles() {
            showLoading('cleanup-status');
            try {
                const response = await fetch('/api/cleanup/temp', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('cleanup-status', 'Temporary files cleaned up successfully', 'success');
                } else {
                    showStatus('cleanup-status', `Cleanup failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('cleanup-status', `Network error: ${error.message}`, 'error');
            }
        }

        async function clearTrash() {
            if (!confirm('Are you sure you want to permanently clear the trash folder?')) return;
            
            showLoading('cleanup-status');
            try {
                const response = await fetch('/api/trash/clear', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('cleanup-status', 'Trash folder cleared successfully', 'success');
                } else {
                    showStatus('cleanup-status', `Clear failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showStatus('cleanup-status', `Network error: ${error.message}`, 'error');
            }
        }

        // Server control
        async function restartServer() {
            if (!confirm('Are you sure you want to restart the server? This will interrupt active connections.')) return;
            
            showLoading('server-status');
            try {
                const response = await fetch('/api/restart', { method: 'POST' });
                showStatus('server-status', 'Server restarting...', 'processing');
                
                // Wait and check if server is back online
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            } catch (error) {
                showStatus('server-status', `Restart failed: ${error.message}`, 'error');
            }
        }

        async function stopServer() {
            if (!confirm('Are you sure you want to stop the server? You will need to restart it manually.')) return;
            
            showLoading('server-status');
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                showStatus('server-status', 'Server stopping...', 'processing');
                
                setTimeout(() => {
                    showStatus('server-status', 'Server stopped. Restart manually to continue.', 'error');
                }, 2000);
            } catch (error) {
                showStatus('server-status', `Stop failed: ${error.message}`, 'error');
            }
        }

        // Header restart button
        const restartBtn = document.getElementById('restartBtn');
        restartBtn?.addEventListener('click', async () => {
            if(!confirm('Are you sure you want to restart the server? This may interrupt current operations.')) return;
            restartBtn.disabled = true;
            restartBtn.innerHTML = '⏳ Restarting...';
            try{
                await fetch('/api/restart', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'}
                });
                setTimeout(() => location.reload(), 4000);
            }catch(err){
                setTimeout(() => location.reload(), 4000);
            }
        });
    </script>
</body>
</html> 