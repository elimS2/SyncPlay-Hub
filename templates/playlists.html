<!-- Playlist list homepage -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Playlists</title>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:20px;}
    h1{margin-bottom:20px;}
    a{color:#61dafb; text-decoration:none; font-size:20px;}
    a:hover{text-decoration:underline;}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:15px;}
    th,td{padding:6px 4px;}
    th{text-align:left;border-bottom:1px solid #444;cursor:pointer;}
    tbody tr{border-bottom:1px solid #333;}
    .arrow{margin-left:4px;font-size:10px;}
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;">Available Playlists</h1>
      <div style="font-size:12px;color:#888;margin-top:4px;">
        Server PID: {{ server_info.pid }} | Started: {{ server_info.start_time }} | Uptime: {{ server_info.uptime }}
      </div>
    </div>
    <div style="display:flex;gap:8px;">
      <a href="/tracks" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Track Library</a>
      <a href="/history" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Play History</a>
      <a href="/logs" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Logs</a>
      <button id="scanBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">Rescan Library</button>
      <button id="addPlBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">Add Playlist</button>
      <button id="restartBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;background:#d32f2f;color:#fff;border:1px solid #b71c1c;">🔄 Restart Server</button>
    </div>
  </div>

  <table id="playlistTable">
    <thead>
      <tr>
        <th>Playlist</th>
        <th>Tracks</th>
        <th>Plays</th>
        <th>Likes</th>
        <th>Forgotten</th>
        <th>Last Sync</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for pl in playlists %}
        <tr data-rel="{{ pl.relpath }}">
          <td><a href="{{ pl.url }}">{{ pl.name }}</a></td>
          <td>{{ pl.count }}</td>
          <td>{{ pl.plays }}</td>
          <td>{{ pl.likes }}</td>
          <td>{{ pl.forgotten }}</td>
          <td>{{ pl.last_sync }}</td>
          <td>
            {% if pl.has_source %}
              <button class="resyncBtn" style="font-size:12px;">Resync</button>
            {% else %}
              <button class="linkBtn" style="font-size:12px;">Link</button>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="6" style="text-align:center;color:#888;">No playlists found in the selected root folder.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    const btn = document.getElementById('scanBtn');
    btn?.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Scanning…';
        try {
            const res = await fetch('/api/scan', {method:'POST'});
            const data = await res.json();
            if(data.status==='ok'){
                alert('Scan completed successfully');
                location.reload();
            }else{
                alert('Scan error: '+ (data.message || 'unknown'));
            }
        }catch(err){
            alert('Request failed: '+err);
        }finally{
            btn.disabled = false;
            btn.textContent = 'Rescan Library';
        }
    });

    /* ---- Add Playlist ---- */
    const addBtn = document.getElementById('addPlBtn');
    addBtn?.addEventListener('click', async () => {
        const url = prompt('Enter YouTube playlist URL:');
        if(!url) return;
        addBtn.disabled = true;
        addBtn.textContent = 'Adding…';
        try{
            const res = await fetch('/api/add_playlist', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({url})
            });
            const data = await res.json();
            if(data.status==='started'){
                alert('Playlist download started. It will appear once finished.');
            }else if(data.status==='exists'){
                alert('Playlist already exists.');
            }else{
                alert('Error: '+ (data.message || 'unknown'));
            }
        }catch(err){
            alert('Request failed: '+err);
        }finally{
            addBtn.disabled = false;
            addBtn.textContent = 'Add Playlist';
        }
    });

    /* ---- Restart Server ---- */
    const restartBtn = document.getElementById('restartBtn');
    restartBtn?.addEventListener('click', async () => {
        if(!confirm('Are you sure you want to restart the server? This may interrupt current operations.')) return;
        restartBtn.disabled = true;
        restartBtn.textContent = '⏳ Restarting...';
        try{
            await fetch('/api/restart', {
                method:'POST',
                headers:{'Content-Type':'application/json'}
            });
            // No alerts, just wait and reload
            setTimeout(() => {
                location.reload();
            }, 3000);
        }catch(err){
            // Server likely restarting, try to reload
            setTimeout(() => {
                location.reload();
            }, 3000);
        }
    });

    // Resync buttons
    document.querySelectorAll('.resyncBtn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const row = btn.closest('tr');
        const rel = row?.dataset.rel;
        if(!rel) return;
        btn.disabled = true; btn.textContent='Sync…';
        try{
          const res = await fetch('/api/resync', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({relpath:rel})});
          const data = await res.json();
          if(data.status==='started'){
            alert('Resync started in background');
          }else{
            alert('Error: '+(data.message||'unknown'));
          }
        }catch(err){alert(err);}finally{btn.disabled=false;btn.textContent='Resync';}
      });
    });

    // Link buttons
    document.querySelectorAll('.linkBtn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const row = btn.closest('tr');
        const rel = row?.dataset.rel;
        const url = prompt('Enter playlist URL:');
        if(!rel || !url) return;
        btn.disabled=true; btn.textContent='Link…';
        try{
          const res= await fetch('/api/link_playlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relpath:rel,url})});
          const data=await res.json();
          if(data.status==='ok') location.reload(); else alert(data.message||'error');
        }catch(err){alert(err);}finally{btn.disabled=false;btn.textContent='Link';}
      });
    });
  </script>
  <script>
    (function(){
      const table=document.getElementById('playlistTable');
      if(!table) return;
      const tbody=table.querySelector('tbody');

      function parseValue(text){
        const t=text.trim();
        if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t)) return new Date(t.replace(' ','T'));
        const num=parseFloat(t.replace(/[^0-9.\-]/g,''));
        if(!isNaN(num)&&/[0-9]/.test(t)) return num;
        return t.toLowerCase();
      }

      let currentIdx=4; let currentAsc=false; // Default to "Forgotten" column (index 4), descending

      function updateIndicators(){
        table.querySelectorAll('thead th').forEach((h,i)=>{
          const s=h.querySelector('.arrow'); if(s) s.remove();
          if(i===currentIdx){
            const a=document.createElement('span'); a.className='arrow'; a.textContent=currentAsc?'▲':'▼';
            h.appendChild(a);
          }
        });
      }

      function sortBy(idx, asc){
        const rows=Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a,b)=>{
          let v1=a.children[idx].innerText.trim();
          let v2=b.children[idx].innerText.trim();
          const empty1=(v1==='-'||v1==='');
          const empty2=(v2==='-'||v2==='');
          if(empty1&&empty2) return 0;
          if(empty1) return asc?1:-1;
          if(empty2) return asc?-1:1;
          v1=parseValue(v1); v2=parseValue(v2);
          if(v1>v2) return asc?1:-1;
          if(v1<v2) return asc?-1:1;
          return 0;
        });
        rows.forEach(r=>tbody.appendChild(r));
        currentIdx=idx; currentAsc=asc; updateIndicators();
      }

      table.querySelectorAll('thead th').forEach((th,idx)=>{
        // skip Action column (last one, index 6)
        if(idx===6){th.style.cursor='default'; return;}
        th.addEventListener('click',()=>{
          const asc=(currentIdx===idx)?!currentAsc:true;
          sortBy(idx, asc);
        });
      });

      // Initial sort by "Forgotten" column (index 4), descending
      sortBy(4, false);
    })();
  </script>
</body>
</html> 