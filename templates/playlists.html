<!-- Playlist list homepage -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Playlists</title>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:20px;}
    h1{margin-bottom:20px;}
    ul{list-style:none; padding:0;}
    li{margin:8px 0;}
    a{color:#61dafb; text-decoration:none; font-size:20px;}
    a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1 style="margin:0;">Available Playlists</h1>
    <div style="display:flex;gap:8px;">
      <a href="/tracks" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Track Library</a>
      <a href="/history" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Play History</a>
      <a href="/logs" style="padding:6px 12px;font-size:14px;background:#222;border:1px solid #444;color:#61dafb;text-decoration:none;display:inline-block;border-radius:4px;">Logs</a>
      <button id="scanBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">Rescan Library</button>
      <button id="addPlBtn" style="padding:6px 12px;font-size:14px;cursor:pointer;">Add Playlist</button>
    </div>
  </div>
  <ul>
    {% for pl in playlists %}
      <li data-rel="{{ pl.relpath }}"><a href="{{ pl.url }}">{{ pl.name }}</a> <span style="font-size:14px;color:#888;">({{ pl.count }} tracks · synced {{ pl.last_sync }})</span>
      {% if pl.has_source %}
        <button class="resyncBtn" style="margin-left:6px;font-size:12px;">Resync</button>
      {% else %}
        <button class="linkBtn" style="margin-left:6px;font-size:12px;">Link</button>
      {% endif %}
      </li>
    {% else %}
      <li>No playlists found in the selected root folder.</li>
    {% endfor %}
  </ul>

  <script>
    const btn = document.getElementById('scanBtn');
    btn?.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Scanning…';
        try {
            const res = await fetch('/api/scan', {method:'POST'});
            const ct = res.headers.get('content-type')||'';
            let data;
            if(ct.includes('application/json')){
                data = await res.json();
            }else{
                const txt = await res.text();
                throw new Error(txt.slice(0,200));
            }
            if(data.status==='ok'){
                alert('Scan completed successfully');
                location.reload();
            }else{
                alert('Scan error: '+ (data.message || 'unknown'));
            }
        }catch(err){
            alert('Request failed: '+err);
        }finally{
            btn.disabled = false;
            btn.textContent = 'Rescan Library';
        }
    });

    /* ---- Add Playlist ---- */
    const addBtn = document.getElementById('addPlBtn');
    addBtn?.addEventListener('click', async () => {
        const url = prompt('Enter YouTube playlist URL:');
        if(!url) return;
        addBtn.disabled = true;
        addBtn.textContent = 'Adding…';
        try{
            const res = await fetch('/api/add_playlist', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({url})
            });
            const ct = res.headers.get('content-type')||'';
            let data;
            if(ct.includes('application/json')){
                data = await res.json();
            }else{
                const txt = await res.text();
                throw new Error(txt.slice(0,200));
            }
            if(data.status==='started'){
                alert('Playlist download started. It will appear once finished.');
            }else if(data.status==='exists'){
                alert('Playlist already exists.');
            }else{
                alert('Error: '+ (data.message || 'unknown'));
            }
        }catch(err){
            alert('Request failed: '+err);
        }finally{
            addBtn.disabled = false;
            addBtn.textContent = 'Add Playlist';
        }
    });

    // Resync buttons
    document.querySelectorAll('.resyncBtn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const li = btn.closest('li');
        const rel = li?.dataset.rel;
        if(!rel) return;
        btn.disabled = true; btn.textContent='Sync…';
        try{
          const res = await fetch('/api/resync', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({relpath:rel})});
          const data = await res.json();
          if(data.status==='started'){
            alert('Resync started in background');
          }else{
            alert('Error: '+(data.message||'unknown'));
          }
        }catch(err){alert(err);}finally{btn.disabled=false;btn.textContent='Resync';}
      });
    });

    // Link buttons
    document.querySelectorAll('.linkBtn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const li = btn.closest('li');
        const rel = li?.dataset.rel;
        const url = prompt('Enter playlist URL:');
        if(!rel || !url) return;
        btn.disabled=true; btn.textContent='Link…';
        try{
          const res= await fetch('/api/link_playlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({relpath:rel,url})});
          const data=await res.json();
          if(data.status==='ok') location.reload(); else alert(data.message||'error');
        }catch(err){alert(err);}finally{btn.disabled=false;btn.textContent='Link';}
      });
    });
  </script>
</body>
</html> 